import{ResourceType as e,ParsedURL as t,UIString as n,Settings as o,Revealer as i}from"../common/common.js";import{StringUtilities as a}from"../platform/platform.js";import{Utils as r,UIUtils as s,ARIAUtils as c,SettingsUI as l,ContextMenu as d,DockController as u,RemoteDebuggingTerminatedScreen as h,Dialog as m,GlassPane as p,TargetCrashedScreen as g}from"../ui/ui.js";import{LiveLocation as k,DebuggerWorkspaceBinding as L,CSSWorkspaceBinding as b,ResourceUtils as f,BlackboxManager as _}from"../bindings/bindings.js";import{InspectorFrontendHost as C}from"../host/host.js";import{SDKModel as S,DebuggerModel as v,NetworkRequest as x}from"../sdk/sdk.js";import{TextUtils as y}from"../text_utils/text_utils.js";import{Workspace as I}from"../workspace/workspace.js";var T=Object.freeze({__proto__:null,ImagePreview:class{static build(t,n,o,i={}){const{precomputedFeatures:s,imageAltText:c}=i,l=t.model(SDK.ResourceTreeModel);if(!l)return Promise.resolve(null);let d,u=l.resourceForURL(n),h=n;if(!g(u)&&s&&s.currentSrc&&(h=s.currentSrc,u=l.resourceForURL(h)),!g(u))return Promise.resolve(null);const m=new Promise(e=>{d=e}),p=createElement("img");return p.addEventListener("load",(function(){const e=createElement("table");r.appendStyle(e,"components/imagePreview.css"),e.className="image-preview-container";const t=p.naturalWidth,i=p.naturalHeight,c=s?s.renderedWidth:t,l=s?s.renderedHeight:i;let u;o&&(u=l!==i||c!==t?ls`${c} × ${l} pixels (intrinsic: ${t} × ${i} pixels)`:ls`${c} × ${l} pixels`);e.createChild("tr").createChild("td","image-container").appendChild(p),u&&(e.createChild("tr").createChild("td").createChild("span","description").textContent=u);h!==n&&(e.createChild("tr").createChild("td").createChild("span","description").textContent=a.sprintf("currentSrc: %s",h.trimMiddle(100)));d(e)}),!1),p.addEventListener("error",()=>d(null),!1),c&&(p.alt=c),u.populateImageSource(p),m;function g(t){return!!t&&t.resourceType()===e.resourceTypes.Image}}static async loadDimensionsForNode(e){if(!e.nodeName()||"img"!==e.nodeName().toLowerCase())return;const t=await e.resolveToObject("");if(!t)return;const n=t.callFunctionJSON((function(){return{renderedWidth:this.width,renderedHeight:this.height,currentSrc:this.currentSrc}}),void 0);return t.release(),n}static defaultAltTextForImageURL(e){const n=new t.ParsedURL(e),o=n.isValid?n.displayName:ls`unknown source`;return ls`Image from ${o}`}}});class w{constructor(e,t,n=(()=>{})){this._maxLength=e||s.MaxLengthForDisplayedURLs,this._anchorsByTarget=new Map,this._locationPoolByTarget=new Map,this._onLiveLocationUpdate=n,this._useLinkDecorator=!!t,U.add(this),S.TargetManager.instance().observeTargets(this)}static setLinkDecorator(e){console.assert(!N,"Cannot re-register link decorator."),N=e,e.addEventListener(H.Events.LinkIconChanged,(function(e){const t=e.data[D]||[];for(const e of t)w._updateLinkDecorations(e)}));for(const e of U)e._updateAllAnchorDecorations()}_updateAllAnchorDecorations(){for(const e of this._anchorsByTarget.values())for(const t of e)w._updateLinkDecorations(t)}static _bindUILocation(e,t){if(w._linkInfo(e).uiLocation=t,!t)return;const n=t.uiSourceCode;let o=n[D];o||(o=new Set,n[D]=o),o.add(e)}static _unbindUILocation(e){const t=w._linkInfo(e);if(!t.uiLocation)return;const n=t.uiLocation.uiSourceCode;t.uiLocation=null;const o=n[D];o&&o.delete(e)}targetAdded(e){this._anchorsByTarget.set(e,[]),this._locationPoolByTarget.set(e,new k.LiveLocationPool)}targetRemoved(e){const t=this._locationPoolByTarget.get(e);this._locationPoolByTarget.delete(e),t.disposeAll();const n=this._anchorsByTarget.get(e);this._anchorsByTarget.delete(e);for(const e of n){const t=w._linkInfo(e);t.liveLocation=null,w._unbindUILocation(e),t.fallback&&(e.href=t.fallback.href,e.title=t.fallback.title,e.className=t.fallback.className,e.textContent=t.fallback.textContent,e[R]=t.fallback[R])}}maybeLinkifyScriptLocation(e,t,n,o,i){const a={className:"",columnNumber:0,...i},{columnNumber:r,className:s}=a;let c=null;if(n&&(c=w.linkifyURL(n,{lineNumber:o,maxLength:this._maxLength,...i})),!e||e.isDisposed())return c;const l=e.model(v.DebuggerModel);if(!l)return c;let d;if(t&&(d=l.createRawLocationByScriptId(t,o,r)),d||(d=l.createRawLocationByURL(n,o,r)),!d)return c;const u=w._createLink("​",s,i),h=w._linkInfo(u);h.enableDecorator=this._useLinkDecorator,h.fallback=c;const m=this._locationPoolByTarget.get(d.debuggerModel.target());L.DebuggerWorkspaceBinding.instance().createLiveLocation(d,this._updateAnchor.bind(this,u),m).then(e=>{h.liveLocation=e,this._onLiveLocationUpdate()});return this._anchorsByTarget.get(d.debuggerModel.target()).push(u),u}linkifyScriptLocation(e,t,n,o,i){return this.maybeLinkifyScriptLocation(e,t,n,o,i)||w.linkifyURL(n,{lineNumber:o,maxLength:this._maxLength,...i})}linkifyRawLocation(e,t,n){return this.linkifyScriptLocation(e.debuggerModel.target(),e.scriptId,t,e.lineNumber,{columnNumber:e.columnNumber,className:n})}maybeLinkifyConsoleCallFrame(e,t,n){return this.maybeLinkifyScriptLocation(e,t.scriptId,t.url,t.lineNumber,{columnNumber:t.columnNumber,...n})}linkifyStackTraceTopFrame(e,t,n){console.assert(t.callFrames&&t.callFrames.length);const o=t.callFrames[0],i=w.linkifyURL(o.url,{className:n,lineNumber:o.lineNumber,columnNumber:o.columnNumber,maxLength:this._maxLength});if(e.isDisposed())return i;const a=e.model(v.DebuggerModel).createRawLocationsByStackTrace(t);if(0===a.length)return i;const r=w._createLink("​",n||""),s=w._linkInfo(r);s.enableDecorator=this._useLinkDecorator,s.fallback=i;const c=this._locationPoolByTarget.get(e);L.DebuggerWorkspaceBinding.instance().createStackTraceTopFrameLiveLocation(a,this._updateAnchor.bind(this,r),c).then(e=>{s.liveLocation=e,this._onLiveLocationUpdate()});return this._anchorsByTarget.get(e).push(r),r}linkifyCSSLocation(e,t){const n=w._createLink("​",t||""),o=w._linkInfo(n);o.enableDecorator=this._useLinkDecorator;const i=this._locationPoolByTarget.get(e.cssModel().target());b.CSSWorkspaceBinding.instance().createLiveLocation(e,this._updateAnchor.bind(this,n),i).then(e=>{o.liveLocation=e,this._onLiveLocationUpdate()});return this._anchorsByTarget.get(e.cssModel().target()).push(n),n}reset(){for(const e of[...this._anchorsByTarget.keys()])this.targetRemoved(e),this.targetAdded(e)}dispose(){for(const e of[...this._anchorsByTarget.keys()])this.targetRemoved(e);S.TargetManager.instance().unobserveTargets(this),U.delete(this)}async _updateAnchor(e,t){w._unbindUILocation(e);const n=await t.uiLocation();if(!n)return;w._bindUILocation(e,n);const o=n.linkText(!0);w._setTrimmedText(e,o,this._maxLength);let i=n.uiSourceCode.url();"application/wasm"===n.uiSourceCode.mimeType()?i+=":0x"+n.columnNumber.toString(16):"number"==typeof n.lineNumber&&(i+=":"+(n.lineNumber+1)),e.title=i,e.classList.toggle("webkit-html-blackbox-link",await t.isBlackboxed()),w._updateLinkDecorations(e)}setLiveLocationUpdateCallback(e){this._onLiveLocationUpdate=e}static _updateLinkDecorations(e){const t=w._linkInfo(e);if(!t||!t.enableDecorator)return;if(!N||!t.uiLocation)return;t.icon&&t.icon.parentElement&&e.removeChild(t.icon);const n=N.linkIcon(t.uiLocation.uiSourceCode);n&&(n.style.setProperty("margin-right","2px"),e.insertBefore(n,e.firstChild)),t.icon=n}static linkifyURL(e,t){const o=(t=t||{}).text,i=t.className||"",a=t.lineNumber,r=t.columnNumber,c=t.preventClick,l=t.maxLength||s.MaxLengthForDisplayedURLs,d=t.bypassURLTrimming;if(!e||e.trim().toLowerCase().startsWith("javascript:")){const t=document.createElement("span");return i&&(t.className=i),t.textContent=o||e||n.UIString("(unknown)"),t}let u=o||f.displayNameForURL(e);"number"!=typeof a||o||(u+=":"+(a+1));const h={maxLength:l,title:u!==e?e:"",href:e,preventClick:c,tabStop:t.tabStop,bypassURLTrimming:d},m=w._createLink(u,i,h),p=w._linkInfo(m);return"number"==typeof a&&(p.lineNumber=a),"number"==typeof r&&(p.columnNumber=r),m}static linkifyRevealable(e,t,n){const o=w._createLink(t,"",{maxLength:s.MaxLengthForDisplayedURLs,href:n});return w._linkInfo(o).revealable=e,o}static _createLink(e,t,n){n=n||{};const{maxLength:o,title:i,href:a,preventClick:r,tabStop:s,bypassURLTrimming:l}=n,d=document.createElement("span");return t&&(d.className=t),d.classList.add("devtools-link"),i&&(d.title=i),a&&(d.href=a),l?(d.classList.add("devtools-link-styled-trim"),w._appendTextWithoutHashes(d,e)):w._setTrimmedText(d,e,o),d[R]={icon:null,enableDecorator:!1,uiLocation:null,liveLocation:null,url:a||null,lineNumber:null,columnNumber:null,revealable:null,fallback:null},r?d.classList.add("devtools-link-prevent-click"):(d.addEventListener("click",e=>{w._handleClick(e)&&e.consume(!0)},!1),d.addEventListener("keydown",e=>{isEnterKey(e)&&w._handleClick(e)&&e.consume(!0)},!1)),c.markAsLink(d),d.tabIndex=s?0:-1,d}static _setTrimmedText(e,t,n){if(e.removeChildren(),n&&t.length>n){const o=function(e,t){let n=Math.floor(t/2),o=e.length-Math.ceil(t/2)+1;e.codePointAt(o-1)>=65536&&(o++,n++);n>0&&e.codePointAt(n-1)>=65536&&n--;return[e.substring(0,n),e.substring(n,o),e.substring(o)]}(t,n);w._appendTextWithoutHashes(e,o[0]),w._appendHiddenText(e,o[1]),w._appendTextWithoutHashes(e,o[2])}else w._appendTextWithoutHashes(e,t)}static _appendTextWithoutHashes(e,t){const n=y.Utils.splitStringByRegexes(t,[/[a-f0-9]{20,}/g]);for(const t of n)-1===t.regexIndex?e.createTextChild(t.value):(e.createTextChild(t.value.substring(0,7)),w._appendHiddenText(e,t.value.substring(7)))}static _appendHiddenText(e,t){e.createChild("span","devtools-link-ellipsis").createTextChild("…")[B]=t}static untruncatedNodeText(e){return e[B]||e.textContent}static _linkInfo(e){return e&&e[R]||null}static _handleClick(e){const t=e.currentTarget;return!s.isBeingEdited(e.target)&&!t.hasSelection()&&w.invokeFirstAction(t)}static invokeFirstAction(e){const t=w._linkActions(e);return!!t.length&&(t[0].handler.call(null),!0)}static _linkHandlerSetting(){return w._linkHandlerSettingInstance||(w._linkHandlerSettingInstance=o.Settings.instance().createSetting("openLinkHandler",ls`auto`)),w._linkHandlerSettingInstance}static registerLinkHandler(e,t){F.set(e,t),self.runtime.sharedInstance(M)._update()}static unregisterLinkHandler(e){F.delete(e),self.runtime.sharedInstance(M)._update()}static uiLocation(e){const t=w._linkInfo(e);return t?t.uiLocation:null}static _linkActions(e){const o=w._linkInfo(e),a=[];if(!o)return a;let r="",c=null;if(o.uiLocation)c=o.uiLocation,r=c.uiSourceCode.contentURL();else if(o.url){r=o.url;const e=I.WorkspaceImpl.instance().uiSourceCodeForURL(r)||I.WorkspaceImpl.instance().uiSourceCodeForURL(t.ParsedURL.urlWithoutHash(r));c=e?e.uiLocation(o.lineNumber||0,o.columnNumber||0):null}const l=r?f.resourceForURL(r):null,d=c?c.uiSourceCode:l,u=o.revealable||c||l;if(u){const e=i.revealDestination(u);a.push({section:"reveal",title:e?ls`Reveal in ${e}`:ls`Reveal`,handler:()=>i.reveal(u)})}if(d){const e=c?c.lineNumber:o.lineNumber||0;for(const t of F.keys()){const o=F.get(t),i={section:"reveal",title:n.UIString("Open using %s",t),handler:o.bind(null,d,e)};t===w._linkHandlerSetting().get()?a.unshift(i):a.push(i)}}return(l||o.url)&&(a.push({section:"reveal",title:s.openLinkExternallyLabel(),handler:()=>C.InspectorFrontendHostInstance.openInNewTab(r)}),a.push({section:"clipboard",title:s.copyLinkAddressLabel(),handler:()=>C.InspectorFrontendHostInstance.copyText(r)})),a}}const U=new Set;let N=null;const D=Symbol("Linkifier.anchors"),R=Symbol("Linkifier.info"),B=Symbol("Linkifier.untruncatedNodeText"),F=new Map;class H{linkIcon(e){}}H.Events={LinkIconChanged:Symbol("LinkIconChanged")};class M{constructor(){this._element=document.createElement("select"),this._element.classList.add("chrome-select"),this._element.addEventListener("change",this._onChange.bind(this),!1),this._update()}_update(){this._element.removeChildren();const e=[...F.keys()];e.unshift(n.UIString("auto"));for(const t of e){const e=createElement("option");e.textContent=t,e.selected=t===w._linkHandlerSetting().get(),this._element.appendChild(e)}this._element.disabled=e.length<=1}_onChange(e){const t=e.target.value;w._linkHandlerSetting().set(t)}settingElement(){return l.createCustomSetting(n.UIString("Link handling:"),this._element)}}var A=Object.freeze({__proto__:null,Linkifier:w,LinkDecorator:H,LinkContextMenuProvider:class{appendApplicableItems(e,t,n){let o=n;for(;o&&!o[R];)o=o.parentNodeOrShadowHost();const i=o,a=w._linkActions(i);for(const e of a)t.section(e.section).appendItem(e.title,e.handler)}},LinkHandlerSettingUI:M,ContentProviderContextMenuProvider:class{appendApplicableItems(e,t,o){const i=o;if(i.contentURL()){t.revealSection().appendItem(s.openLinkExternallyLabel(),()=>C.InspectorFrontendHostInstance.openInNewTab(i.contentURL()));for(const e of F.keys()){const o=F.get(e);t.revealSection().appendItem(n.UIString("Open using %s",e),o.bind(null,i,0))}i instanceof x.NetworkRequest||t.clipboardSection().appendItem(s.copyLinkAddressLabel(),()=>C.InspectorFrontendHostInstance.copyText(i.contentURL()))}}},_LinkInfo:void 0,LinkifyURLOptions:void 0,LinkifyOptions:void 0,_CreateLinkOptions:void 0,LinkHandler:void 0});var E=Object.freeze({__proto__:null,buildStackTracePreviewContents:function(e,t,n={}){const{stackTrace:o,contentUpdated:i,tabStops:a}=n,c=document.createElement("span");c.classList.add("monospace"),c.style.display="inline-block";const l=r.createShadowRootWithCoreStyles(c,"components/jsUtils.css").createChild("table","stack-preview-container");let u=0,h=0;const m=[];function p(n){let o=0;for(const i of n.callFrames){h++;let r=h>30&&n.callFrames.length>31;const c=createElement("tr");c.createChild("td").textContent="\n",c.createChild("td","function-name").textContent=s.beautifyFunctionName(i.functionName);const d=t.maybeLinkifyConsoleCallFrame(e,i,{tabStop:!!a});if(d){d.addEventListener("contextmenu",g.bind(null,d));const e=w.uiLocation(d);e&&_.BlackboxManager.instance().isBlackboxedUISourceCode(e.uiSourceCode)&&(r=!0),c.createChild("td").textContent=" @ ",c.createChild("td").appendChild(d),m.push(d)}r&&(c.classList.add("blackboxed"),++o),l.appendChild(c)}return u+=o,n.callFrames.length===o}function g(e,t){const n=new d.ContextMenu(t);t.consume(!0);const o=w.uiLocation(e);o&&_.BlackboxManager.instance().canBlackboxUISourceCode(o.uiSourceCode)&&(_.BlackboxManager.instance().isBlackboxedUISourceCode(o.uiSourceCode)?n.debugSection().appendItem(ls`Stop blackboxing`,()=>_.BlackboxManager.instance().unblackboxUISourceCode(o.uiSourceCode)):n.debugSection().appendItem(ls`Blackbox script`,()=>_.BlackboxManager.instance().blackboxUISourceCode(o.uiSourceCode))),n.appendApplicableItems(t),n.show()}if(!o)return{element:c,links:m};p(o);let k=o.parent;for(;k;){if(!k.callFrames.length){k=k.parent;continue}const e=l.createChild("tr");e.createChild("td").textContent="\n",e.createChild("td","stack-preview-async-description").textContent=s.asyncStackTraceLabel(k.description),e.createChild("td"),e.createChild("td"),p(k)&&e.classList.add("blackboxed"),k=k.parent}if(u){const e=l.createChild("tr","show-blackboxed-link");e.createChild("td").textContent="\n";const t=e.createChild("td");t.colSpan=4;const n=t.createChild("span","link");n.textContent=1===u?ls`Show 1 more frame`:ls`Show ${u} more frames`,n.addEventListener("click",()=>{l.classList.add("show-blackboxed"),i&&i()},!1)}return{element:c,links:m}},Options:void 0});var P=Object.freeze({__proto__:null,reload:function(){self.UI.dockController.canDock()&&self.UI.dockController.dockSide()===u.State.Undocked&&C.InspectorFrontendHostInstance.setIsDocked(!0,(function(){})),C.InspectorFrontendHostInstance.reattach(()=>window.location.reload())}});class W extends S.SDKModel{constructor(e){super(e),e.registerInspectorDispatcher(this),e.inspectorAgent().enable(),this._hideCrashedDialog=null,W._disconnectedScreenWithReasonWasShown=!1}detached(e){W._disconnectedScreenWithReasonWasShown=!0,h.RemoteDebuggingTerminatedScreen.show(e)}static webSocketConnectionLost(){h.RemoteDebuggingTerminatedScreen.show(ls`WebSocket disconnected`)}targetCrashed(){if(this.target().parentTarget())return;const e=new m.Dialog;e.setSizeBehavior(p.SizeBehavior.MeasureContent),e.addCloseButton(),e.setDimmed(!0),this._hideCrashedDialog=e.hide.bind(e),new g.TargetCrashedScreen(()=>{this._hideCrashedDialog=null}).show(e.contentElement),e.show()}targetReloadedAfterCrash(){this.target().runtimeAgent().runIfWaitingForDebugger(),this._hideCrashedDialog&&(this._hideCrashedDialog.call(null),this._hideCrashedDialog=null)}}S.SDKModel.register(W,S.Capability.Inspector,!0);var j=Object.freeze({__proto__:null,TargetDetachedDialog:W});export{T as ImagePreview,E as JSPresentationUtils,A as Linkifier,P as Reload,j as TargetDetachedDialog};
