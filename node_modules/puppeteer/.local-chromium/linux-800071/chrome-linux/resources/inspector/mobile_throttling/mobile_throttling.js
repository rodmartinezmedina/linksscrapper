import{UIString as t,Revealer as e,ObjectWrapper as i,Settings as n}from"../common/common.js";import{NetworkManager as o,SDKModel as s,EmulationModel as r}from"../sdk/sdk.js";import{userMetrics as l,UserMetrics as a}from"../host/host.js";import{ARIAUtils as d,Toolbar as c,Icon as h,Widget as g,UIUtils as u,ListWidget as p}from"../ui/ui.js";const C={NoThrottling:1,MidTierMobile:4,LowEndMobile:6},w={title:o.NoThrottlingConditions.title,description:t.UIString("No throttling"),network:o.NoThrottlingConditions,cpuThrottlingRate:C.NoThrottling},k={title:o.OfflineConditions.title,description:t.UIString("No internet connectivity"),network:o.OfflineConditions,cpuThrottlingRate:C.NoThrottling},_={title:t.UIString("Low-end mobile"),description:t.UIString("Slow 3G & 6x CPU slowdown"),network:o.Slow3GConditions,cpuThrottlingRate:C.LowEndMobile},m={title:t.UIString("Mid-tier mobile"),description:t.UIString("Fast 3G & 4x CPU slowdown"),network:o.Fast3GConditions,cpuThrottlingRate:C.MidTierMobile},b={title:t.UIString("Custom"),description:t.UIString("Check Network and Performance panels")},v=[m,_,b],T=[k],f=[o.Fast3GConditions,o.Slow3GConditions,o.OfflineConditions],N=[C.NoThrottling,C.MidTierMobile,C.LowEndMobile];var M=Object.freeze({__proto__:null,CPUThrottlingRates:C,NoThrottlingConditions:w,OfflineConditions:k,LowEndMobileConditions:_,MidTierMobileConditions:m,CustomConditions:b,mobilePresets:v,advancedMobilePresets:T,networkPresets:f,cpuThrottlingPresets:N,Conditions:void 0,NetworkThrottlingConditionsGroup:void 0,MobileThrottlingConditionsGroup:void 0,ConditionsList:void 0,PlaceholderConditions:void 0});class S{constructor(t,e,i){this._populateCallback=t,this._selectCallback=e,this._customNetworkConditionsSetting=i,this._customNetworkConditionsSetting.addChangeListener(this._populateOptions,this),o.MultitargetNetworkManager.instance().addEventListener(o.MultitargetNetworkManager.Events.ConditionsChanged,()=>{this._networkConditionsChanged()},this),this._options,this._populateOptions()}revealAndUpdate(){e.reveal(this._customNetworkConditionsSetting),this._networkConditionsChanged()}optionSelected(t){o.MultitargetNetworkManager.instance().setNetworkConditions(t)}_populateOptions(){const e={title:t.UIString("Disabled"),items:[o.NoThrottlingConditions]},i={title:t.UIString("Presets"),items:f},n={title:t.UIString("Custom"),items:this._customNetworkConditionsSetting.get()};if(this._options=this._populateCallback([e,i,n]),!this._networkConditionsChanged())for(let t=this._options.length-1;t>=0;t--)if(this._options[t]){this.optionSelected(this._options[t]);break}}_networkConditionsChanged(){const t=o.MultitargetNetworkManager.instance().networkConditions();for(let e=0;e<this._options.length;++e){const i=this._options[e];if(i&&i.download===t.download&&i.upload===t.upload&&i.latency===t.latency&&i.title===t.title)return this._selectCallback(e),!0}return!1}}var I=Object.freeze({__proto__:null,NetworkThrottlingSelector:S});class x extends i.ObjectWrapper{constructor(){super(),this._cpuThrottlingRate=C.NoThrottling,this._cpuThrottlingControls=new Set,this._cpuThrottlingRates=N,this._customNetworkConditionsSetting=n.Settings.instance().moduleSetting("customNetworkConditions"),this._currentNetworkThrottlingConditions=o.NoThrottlingConditions,this._lastNetworkThrottlingConditions,o.MultitargetNetworkManager.instance().addEventListener(o.MultitargetNetworkManager.Events.ConditionsChanged,()=>{this._lastNetworkThrottlingConditions=this._currentNetworkThrottlingConditions,this._currentNetworkThrottlingConditions=o.MultitargetNetworkManager.instance().networkConditions()}),s.TargetManager.instance().observeModels(r.EmulationModel,this)}decorateSelectWithNetworkThrottling(t){let e=[];const i=new S((function(i){t.removeChildren(),e=[];for(let n=0;n<i.length;++n){const o=i[n],s=t.createChild("optgroup");s.label=o.title;for(const t of o.items){const i=t.title,n=new Option(i,i);d.setAccessibleName(n,ls`${o.title}: ${i}`),s.appendChild(n),e.push(t)}if(n===i.length-1){const t=new Option(ls`Add…`,ls`Add…`);d.setAccessibleName(t,ls`Add ${o.title}`),s.appendChild(t),e.push(null)}}return e}),(function(e){t.selectedIndex!==e&&(t.selectedIndex=e)}),this._customNetworkConditionsSetting);return t.addEventListener("change",(function(){t.selectedIndex===t.options.length-1?i.revealAndUpdate():i.optionSelected(e[t.selectedIndex])}),!1),i}createOfflineToolbarCheckbox(){const e=new c.ToolbarCheckbox(t.UIString("Offline"),t.UIString("Force disconnected from network"),function(){e.checked()?o.MultitargetNetworkManager.instance().setNetworkConditions(o.OfflineConditions):o.MultitargetNetworkManager.instance().setNetworkConditions(this._lastNetworkThrottlingConditions)}.bind(this));return o.MultitargetNetworkManager.instance().addEventListener(o.MultitargetNetworkManager.Events.ConditionsChanged,(function(){e.setChecked(o.MultitargetNetworkManager.instance().networkConditions()===o.OfflineConditions)})),e.setChecked(o.MultitargetNetworkManager.instance().networkConditions()===o.OfflineConditions),e}createMobileThrottlingButton(){const e=new c.ToolbarMenuButton((function(e){for(let s=0;s<i.length;++s){const r=i[s];r&&(r.title===b.title&&r.description===b.description||e.defaultSection().appendCheckboxItem(t.UIString(r.title),o.optionSelected.bind(o,r),n===s))}}));e.setTitle(t.UIString("Throttling")),e.setGlyph(""),e.turnIntoSelect(),e.setDarkText();let i=[],n=-1;const o=new O((function(t){i=[];for(const e of t){for(const t of e.items)i.push(t);i.push(null)}return i}),(function(t){n=t,e.setText(i[t].title),e.setTitle(i[t].description)}));return e}cpuThrottlingRate(){return this._cpuThrottlingRate}setCPUThrottlingRate(e){this._cpuThrottlingRate=e;for(const t of s.TargetManager.instance().models(r.EmulationModel))t.setCPUThrottlingRate(this._cpuThrottlingRate);let i=null;this._cpuThrottlingRate!==C.NoThrottling&&(l.actionTaken(a.Action.CpuThrottlingEnabled),i=h.Icon.create("smallicon-warning"),i.title=t.UIString("CPU throttling is enabled"));const n=this._cpuThrottlingRates.indexOf(this._cpuThrottlingRate);for(const t of this._cpuThrottlingControls)t.setSelectedIndex(n);self.UI.inspectorView.setPanelIcon("timeline",i),this.dispatchEventToListeners(U.RateChanged,this._cpuThrottlingRate)}modelAdded(t){this._cpuThrottlingRate!==C.NoThrottling&&t.setCPUThrottlingRate(this._cpuThrottlingRate)}modelRemoved(t){}createCPUThrottlingSelector(){const e=new c.ToolbarComboBox(t=>this.setCPUThrottlingRate(this._cpuThrottlingRates[t.target.selectedIndex]),ls`CPU throttling`);this._cpuThrottlingControls.add(e);const i=this._cpuThrottlingRate;for(let n=0;n<this._cpuThrottlingRates.length;++n){const o=this._cpuThrottlingRates[n],s=1===o?t.UIString("No throttling"):t.UIString("%d× slowdown",o),r=e.createOption(s);e.addOption(r),i===o&&e.setSelectedIndex(n)}return e}}const U={RateChanged:Symbol("RateChanged")};function R(){return self.singleton(x)}var E=Object.freeze({__proto__:null,ThrottlingManager:x,Events:U,ActionDelegate:class{handleAction(t,e){return"network-conditions.network-online"===e?(o.MultitargetNetworkManager.instance().setNetworkConditions(o.NoThrottlingConditions),!0):"network-conditions.network-low-end-mobile"===e?(o.MultitargetNetworkManager.instance().setNetworkConditions(o.Slow3GConditions),!0):"network-conditions.network-mid-tier-mobile"===e?(o.MultitargetNetworkManager.instance().setNetworkConditions(o.Fast3GConditions),!0):"network-conditions.network-offline"===e&&(o.MultitargetNetworkManager.instance().setNetworkConditions(o.OfflineConditions),!0)}},throttlingManager:R});class O{constructor(t,e){this._populateCallback=t,this._selectCallback=e,R().addEventListener(U.RateChanged,this._conditionsChanged,this),o.MultitargetNetworkManager.instance().addEventListener(o.MultitargetNetworkManager.Events.ConditionsChanged,this._conditionsChanged,this),this._options=this._populateOptions(),this._conditionsChanged()}optionSelected(t){o.MultitargetNetworkManager.instance().setNetworkConditions(t.network),R().setCPUThrottlingRate(t.cpuThrottlingRate)}_populateOptions(){const e={title:t.UIString("Disabled"),items:[w]},i={title:t.UIString("Presets"),items:v},n={title:t.UIString("Advanced"),items:T};return this._populateCallback([e,i,n])}_conditionsChanged(){const t=o.MultitargetNetworkManager.instance().networkConditions(),e=R().cpuThrottlingRate();for(let i=0;i<this._options.length;++i){const n=this._options[i];if(n&&n.network===t&&n.cpuThrottlingRate===e)return void this._selectCallback(i)}this._selectCallback(this._options.indexOf(b))}}var P=Object.freeze({__proto__:null,MobileThrottlingSelector:O});var L=Object.freeze({__proto__:null,NetworkPanelIndicator:class{constructor(){if(!self.UI.inspectorView.hasPanel("network"))return;const e=o.MultitargetNetworkManager.instance();function i(){let i=null;e.isThrottling()?(i=h.Icon.create("smallicon-warning"),i.title=t.UIString("Network throttling is enabled")):o.MultitargetNetworkManager.instance().isIntercepting()?(i=h.Icon.create("smallicon-warning"),i.title=t.UIString("Requests may be rewritten by local overrides")):e.isBlocking()&&(i=h.Icon.create("smallicon-warning"),i.title=t.UIString("Requests may be blocked")),self.UI.inspectorView.setPanelIcon("network",i)}e.addEventListener(o.MultitargetNetworkManager.Events.ConditionsChanged,i),e.addEventListener(o.MultitargetNetworkManager.Events.BlockedPatternsChanged,i),e.addEventListener(o.MultitargetNetworkManager.Events.InterceptorsChanged,i),i()}}});class A extends g.VBox{constructor(){super(!0),this.registerRequiredCSS("mobile_throttling/throttlingSettingsTab.css");const e=this.contentElement.createChild("div","header");e.textContent=ls`Network Throttling Profiles`,d.markAsHeading(e,1);const i=u.createTextButton(t.UIString("Add custom profile..."),this._addButtonClicked.bind(this),"add-conditions-button");this.contentElement.appendChild(i),this._list=new p.ListWidget(this),this._list.element.classList.add("conditions-list"),this._list.registerRequiredCSS("mobile_throttling/throttlingSettingsTab.css"),this._list.show(this.contentElement),this._customSetting=n.Settings.instance().moduleSetting("customNetworkConditions"),this._customSetting.addChangeListener(this._conditionsUpdated,this),this.setDefaultFocusedElement(i)}wasShown(){super.wasShown(),this._conditionsUpdated()}_conditionsUpdated(){this._list.clear();const t=this._customSetting.get();for(let e=0;e<t.length;++e)this._list.appendItem(t[e],!0);this._list.appendSeparator()}_addButtonClicked(){this._list.addNewItem(this._customSetting.get().length,{title:"",download:-1,upload:-1,latency:0})}renderItem(e,i){const n=e,o=document.createElement("div");o.classList.add("conditions-list-item");const s=o.createChild("div","conditions-list-text conditions-list-title").createChild("div","conditions-list-title-text");return s.textContent=n.title,s.title=n.title,o.createChild("div","conditions-list-separator"),o.createChild("div","conditions-list-text").textContent=y(n.download),o.createChild("div","conditions-list-separator"),o.createChild("div","conditions-list-text").textContent=y(n.upload),o.createChild("div","conditions-list-separator"),o.createChild("div","conditions-list-text").textContent=t.UIString("%dms",n.latency),o}removeItemRequested(t,e){const i=this._customSetting.get();i.splice(e,1),this._customSetting.set(i)}commitEdit(t,e,i){const n=t;n.title=e.control("title").value.trim();const o=e.control("download").value.trim();n.download=o?128*parseInt(o,10):-1;const s=e.control("upload").value.trim();n.upload=s?128*parseInt(s,10):-1;const r=e.control("latency").value.trim();n.latency=r?parseInt(r,10):0;const l=this._customSetting.get();i&&l.push(n),this._customSetting.set(l)}beginEdit(t){const e=t,i=this._createEditor();return i.control("title").value=e.title,i.control("download").value=e.download<=0?"":String(e.download/128),i.control("upload").value=e.upload<=0?"":String(e.upload/128),i.control("latency").value=e.latency?String(e.latency):"",i}_createEditor(){if(this._editor)return this._editor;const t=new p.Editor;this._editor=t;const e=t.contentElement(),i=e.createChild("div","conditions-edit-row"),n=i.createChild("div","conditions-list-text conditions-list-title"),o=ls`Profile Name`;n.textContent=o,i.createChild("div","conditions-list-separator conditions-list-separator-invisible");const s=i.createChild("div","conditions-list-text"),r=ls`Download`;s.textContent=r,i.createChild("div","conditions-list-separator conditions-list-separator-invisible");const l=i.createChild("div","conditions-list-text"),a=ls`Upload`;l.textContent=a,i.createChild("div","conditions-list-separator conditions-list-separator-invisible");const c=i.createChild("div","conditions-list-text"),h=ls`Latency`;c.textContent=h;const g=e.createChild("div","conditions-edit-row"),u=t.createInput("title","text","",(function(t,e,i){const n=i.value.trim(),o=n.length>0&&n.length<=49;if(!o){const t=ls`Profile Name characters length must be between 1 to ${49} inclusive`;return{valid:o,errorMessage:t}}return{valid:o}}));d.setAccessibleName(u,o),g.createChild("div","conditions-list-text conditions-list-title").appendChild(u),g.createChild("div","conditions-list-separator conditions-list-separator-invisible");let C=g.createChild("div","conditions-list-text");const w=t.createInput("download","text",ls`kb/s`,v);C.appendChild(w),d.setAccessibleName(w,r);const k=C.createChild("div","conditions-edit-optional"),_=ls`optional`;k.textContent=_,d.setDescription(w,_),g.createChild("div","conditions-list-separator conditions-list-separator-invisible"),C=g.createChild("div","conditions-list-text");const m=t.createInput("upload","text",ls`kb/s`,v);d.setAccessibleName(m,a),C.appendChild(m);C.createChild("div","conditions-edit-optional").textContent=_,d.setDescription(m,_),g.createChild("div","conditions-list-separator conditions-list-separator-invisible"),C=g.createChild("div","conditions-list-text");const b=t.createInput("latency","text",ls`ms`,(function(t,e,i){const n=i.value.trim(),o=Number(n),s=Number.isInteger(o)&&o>=0&&o<=1e6;if(!s){const t=ls`Latency must be an integer between ${0}ms to ${1e6}ms inclusive`;return{valid:s,errorMessage:t}}return{valid:s}}));d.setAccessibleName(b,h),C.appendChild(b);return C.createChild("div","conditions-edit-optional").textContent=_,d.setDescription(b,_),t;function v(t,e,i){const n=i.value.trim(),o=Number(n),s=i.getAttribute("aria-label"),r=!Number.isNaN(o)&&o>=0&&o<=1e7;if(!r){return{valid:r,errorMessage:ls`${s} must be a number between ${0}kb/s to ${1e7}kb/s inclusive`}}return{valid:r}}}}function y(e,i){if(e<0)return"";const n=e/128,o=i?"":" ";return n<1024?t.UIString("%d%skb/s",n,o):n<10240?t.UIString("%.1f%sMb/s",n/1024,o):t.UIString("%d%sMb/s",n/1024|0,o)}var j=Object.freeze({__proto__:null,ThrottlingSettingsTab:A,throughputText:y});export{P as MobileThrottlingSelector,L as NetworkPanelIndicator,I as NetworkThrottlingSelector,E as ThrottlingManager,M as ThrottlingPresets,j as ThrottlingSettingsTab};
