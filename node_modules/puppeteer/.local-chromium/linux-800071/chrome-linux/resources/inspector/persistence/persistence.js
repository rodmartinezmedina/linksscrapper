import{NetworkProject as e}from"../bindings/bindings.js";import{Settings as t,UIString as s,ParsedURL as i,ResourceType as n,ObjectWrapper as o,Console as r,EventTarget as d,CharacterIdMap as a,Throttler as l,Trie as c,Revealer as h}from"../common/common.js";import{StringUtilities as u}from"../platform/platform.js";import{SDKModel as m,NetworkManager as p}from"../sdk/sdk.js";import{Workspace as _,UISourceCode as f}from"../workspace/workspace.js";import{TextUtils as S}from"../text_utils/text_utils.js";import{InspectorFrontendHost as y,Platform as g,userMetrics as F,UserMetrics as v,InspectorFrontendHostAPI as C}from"../host/host.js";import{Linkifier as w}from"../components/components.js";import{Icon as P,Widget as b,UIUtils as I,ListWidget as k,ARIAUtils as x,Toolbar as E}from"../ui/ui.js";class U{constructor(e,t){this._path=e,this._type=t}getMetadata(e){return Promise.resolve(null)}initialFilePaths(){return[]}initialGitFolders(){return[]}path(){return this._path}embedderPath(){throw new Error("Not implemented")}type(){return this._type}async createFile(e,t){return Promise.resolve(null)}deleteFile(e){return Promise.resolve(!1)}requestFileBlob(e){return Promise.resolve(null)}async requestFileContent(e){return{content:null,error:ls`Unable to read files with this implementation.`,isEncoded:!1}}setFileContent(e,t,s){throw new Error("Not implemented")}renameFile(e,t,s){s(!1)}addExcludedFolder(e){}removeExcludedFolder(e){}fileSystemRemoved(){}isFileExcluded(e){return!1}excludedFolders(){return new Set}searchInPath(e,t){return Promise.resolve([])}indexContent(e){setImmediate(()=>e.done())}mimeFromPath(e){throw new Error("Not implemented")}canExcludeFolder(e){return!1}contentType(e){throw new Error("Not implemented")}tooltipForURL(e){throw new Error("Not implemented")}supportsAutomapping(){throw new Error("Not implemented")}}var R=Object.freeze({__proto__:null,PlatformFileSystem:U});class L extends U{constructor(e,s,i,n,o){super(s,o),this._manager=e,this._embedderPath=i,this._domFileSystem=n,this._excludedFoldersSetting=t.Settings.instance().createLocalSetting("workspaceExcludedFolders",{}),this._excludedFolders=new Set(this._excludedFoldersSetting.get()[s]||[]),this._excludedEmbedderFolders=[],this._initialFilePaths=new Set,this._initialGitFolders=new Set,this._fileLocks=new Map}static create(e,t,s,i,n,o){const r=y.InspectorFrontendHostInstance.isolatedFileSystem(n,o);if(!r)return Promise.resolve(null);const d=new L(e,t,s,r,i);return d._initializeFilePaths().then(()=>d).catch(e=>{console.error(e)})}static errorMessage(e){return s.UIString("File system error: %s",e.message)}_serializedFileOperation(e,t){const s=Promise.resolve(this._fileLocks.get(e)).then(()=>t.call(null));return this._fileLocks.set(e,s),s}getMetadata(e){let t;const s=new Promise(e=>{t=e});return this._domFileSystem.root.getFile(e,void 0,(function(e){e.getMetadata(t,i)}),i),s;function i(s){const i=L.errorMessage(s);console.error(i+" when getting file metadata '"+e),t(null)}}initialFilePaths(){return[...this._initialFilePaths]}initialGitFolders(){return[...this._initialGitFolders]}embedderPath(){return this._embedderPath}_initializeFilePaths(){let e;const t=new Promise(t=>{e=t});let s=1;const n=function(t){for(let e=0;e<t.length;++e){const o=t[e];if(o.isDirectory){if(o.fullPath.endsWith("/.git")){const e=o.fullPath.lastIndexOf("/"),t=o.fullPath.substring(1,e);this._initialGitFolders.add(t)}if(this.isFileExcluded(o.fullPath+"/")){this._excludedEmbedderFolders.push(i.ParsedURL.urlToPlatformPath(this.path()+o.fullPath,g.isWin()));continue}++s,this._requestEntries(o.fullPath,n)}else{if(this.isFileExcluded(o.fullPath))continue;this._initialFilePaths.add(o.fullPath.substr(1))}}0==--s&&e()}.bind(this);return this._requestEntries("",n),t}async _createFoldersIfNotExist(e){let t=await new Promise(t=>this._domFileSystem.root.getDirectory(e,void 0,t,()=>t(null)));if(t)return t;const s=e.split("/");let i="";for(const e of s)if(i=i+"/"+e,t=await this._innerCreateFolderIfNeeded(i),!t)return null;return t}_innerCreateFolderIfNeeded(e){return new Promise(t=>{this._domFileSystem.root.getDirectory(e,{create:!0},e=>t(e),s=>{const i=L.errorMessage(s);console.error(i+" trying to create directory '"+e+"'"),t(null)})})}async createFile(e,t){const s=await this._createFoldersIfNotExist(e);if(!s)return null;const i=await this._serializedFileOperation(e,function t(i,n){return new Promise(o=>{const r=i+(n||"");s.getFile(r,{create:!0,exclusive:!0},o,s=>{if("InvalidModificationError"===s.name)return void o(t.call(this,i,n?n+1:1));const d=L.errorMessage(s);console.error(d+" when testing if file exists '"+this.path()+"/"+e+"/"+r+"'"),o(null)})})}.bind(this,t||"NewFile"));return i?i.fullPath.substr(1):null}deleteFile(e){let t;const s=new Promise(e=>{t=e});return this._domFileSystem.root.getFile(e,void 0,function(e){e.remove(i,n.bind(this))}.bind(this),n.bind(this)),s;function i(){t(!0)}function n(s){const i=L.errorMessage(s);console.error(i+" when deleting file '"+this.path()+"/"+e+"'"),t(!1)}}requestFileBlob(e){return new Promise(t=>{function s(s){if("NotFoundError"===s.name)return void t(null);const i=L.errorMessage(s);console.error(i+" when getting content for file '"+this.path()+"/"+e+"'"),t(null)}this._domFileSystem.root.getFile(e,void 0,e=>{e.file(t,s.bind(this))},s.bind(this))})}requestFileContent(e){return this._serializedFileOperation(e,()=>this._innerRequestFileContent(e))}async _innerRequestFileContent(e){const t=await this.requestFileBlob(e);if(!t)return{content:null,error:ls`Blob could not be loaded.`,isEncoded:!1};const s=new FileReader,n=i.ParsedURL.extractExtension(e),o=A.has(n),r=new Promise(e=>{s.onloadend=e});if(o?s.readAsBinaryString(t):s.readAsText(t),await r,s.error){const t=ls`Can't read file: ${e}: ${s.error}`;return console.error(t),{content:null,isEncoded:!1,error:t}}let d=null,a=null;try{d=s.result}catch(t){d=null,a=ls`Can't read file: ${e}: ${t.message}`}return null==d?(a=a||ls`Unknown error reading file: ${e}`,console.error(a),{content:null,isEncoded:!1,error:a}):{isEncoded:o,content:o?btoa(d):d}}async setFileContent(e,t,s){let i;F.actionTaken(v.Action.FileSavedInWorkspace);function n(e){e.createWriter(o.bind(this),r.bind(this))}async function o(e){let n;e.onerror=r.bind(this),e.onwriteend=function(){e.onwriteend=i,e.truncate(n.size)},n=s?await(await fetch("data:application/octet-stream;base64,"+t)).blob():new Blob([t],{type:"text/plain"}),e.write(n)}function r(t){const s=L.errorMessage(t);console.error(s+" when setting content for file '"+this.path()+"/"+e+"'"),i()}this._serializedFileOperation(e,()=>{const t=new Promise(e=>{i=e});return this._domFileSystem.root.getFile(e,{create:!0},n.bind(this),r.bind(this)),t})}renameFile(e,t,s){if(!(t=t?t.trim():t)||-1!==t.indexOf("/"))return void s(!1);let i,n;function o(e){n=e,n.getFile(t,null,r,d.bind(this))}function r(e){s(!1)}function d(e){"NotFoundError"===e.name?i.moveTo(n,t,a,l.bind(this)):s(!1)}function a(e){s(!0,e.name)}function l(i){const n=L.errorMessage(i);console.error(n+" when renaming file '"+this.path()+"/"+e+"' to '"+t+"'"),s(!1)}this._domFileSystem.root.getFile(e,void 0,function(e){if(e.name===t)return void s(!1);i=e,i.getParent(o.bind(this),l.bind(this))}.bind(this),l.bind(this))}_readDirectory(e,t){const s=e.createReader();let i=[];function n(s){const i=L.errorMessage(s);console.error(i+" when reading directory '"+e.fullPath+"'"),t([])}s.readEntries((function e(o){var r;o.length?(i=i.concat((r=o,Array.prototype.slice.call(r||[],0))),s.readEntries(e,n)):t(i.sort())}),n)}_requestEntries(e,t){this._domFileSystem.root.getDirectory(e,void 0,function(e){this._readDirectory(e,t)}.bind(this),(function(s){const i=L.errorMessage(s);console.error(i+" when requesting entry '"+e+"'"),t([])}))}_saveExcludedFolders(){const e=this._excludedFoldersSetting.get();e[this.path()]=[...this._excludedFolders],this._excludedFoldersSetting.set(e)}addExcludedFolder(e){this._excludedFolders.add(e),this._saveExcludedFolders(),this._manager.dispatchEventToListeners(O.ExcludedFolderAdded,e)}removeExcludedFolder(e){this._excludedFolders.delete(e),this._saveExcludedFolders(),this._manager.dispatchEventToListeners(O.ExcludedFolderRemoved,e)}fileSystemRemoved(){const e=this._excludedFoldersSetting.get();delete e[this.path()],this._excludedFoldersSetting.set(e)}isFileExcluded(e){if(this._excludedFolders.has(e))return!0;const t=this._manager.workspaceFolderExcludePatternSetting().asRegExp();return!(!t||!t.test(e))}excludedFolders(){return this._excludedFolders}searchInPath(e,t){return new Promise(s=>{const n=this._manager.registerCallback((function(e){s(e.map(e=>i.ParsedURL.platformPathToURL(e))),t.worked(1)}));y.InspectorFrontendHostInstance.searchInPath(n,this._embedderPath,e)})}indexContent(e){e.setTotalWork(1);const t=this._manager.registerProgress(e);y.InspectorFrontendHostInstance.indexPath(t,this._embedderPath,JSON.stringify(this._excludedEmbedderFolders))}mimeFromPath(e){return n.ResourceType.mimeFromURL(e)||"text/plain"}canExcludeFolder(e){return!!e&&"overrides"!==this.type()}contentType(e){const t=i.ParsedURL.extractExtension(e);return j.has(t)?n.resourceTypes.Stylesheet:T.has(t)?n.resourceTypes.Document:B.has(t)?n.resourceTypes.Image:W.has(t)?n.resourceTypes.Script:A.has(t)?n.resourceTypes.Other:n.resourceTypes.Document}tooltipForURL(e){const t=i.ParsedURL.urlToPlatformPath(e,g.isWin()).trimMiddle(150);return ls`Linked to ${t}`}supportsAutomapping(){return"overrides"!==this.type()}}const j=new Set(["css","scss","sass","less"]),T=new Set(["htm","html","asp","aspx","phtml","jsp"]),W=new Set(["asp","aspx","c","cc","cljs","coffee","cpp","cs","dart","java","js","jsp","jsx","h","m","mjs","mm","py","sh","ts","tsx","ls"]),B=new Set(["jpeg","jpg","svg","gif","webp","png","ico","tiff","tif","bmp"]),A=new Set(["cmd","com","exe","a","ar","iso","tar","bz2","gz","lz","lzma","z","7z","apk","arc","cab","dmg","jar","pak","rar","zip","3gp","aac","aiff","flac","m4a","mmf","mp3","ogg","oga","raw","sln","wav","wma","webm","mkv","flv","vob","ogv","gifv","avi","mov","qt","mp4","m4p","m4v","mpg","mpeg","jpeg","jpg","gif","webp","png","ico","tiff","tif","bmp"]);var M=Object.freeze({__proto__:null,IsolatedFileSystem:L,BinaryExtensions:A});let N;class q extends o.ObjectWrapper{constructor(){super(),this._fileSystems=new Map,this._callbacks=new Map,this._progresses=new Map,y.InspectorFrontendHostInstance.events.addEventListener(C.Events.FileSystemRemoved,this._onFileSystemRemoved,this),y.InspectorFrontendHostInstance.events.addEventListener(C.Events.FileSystemAdded,e=>{this._onFileSystemAdded(e)},this),y.InspectorFrontendHostInstance.events.addEventListener(C.Events.FileSystemFilesChangedAddedRemoved,this._onFileSystemFilesChanged,this),y.InspectorFrontendHostInstance.events.addEventListener(C.Events.IndexingTotalWorkCalculated,this._onIndexingTotalWorkCalculated,this),y.InspectorFrontendHostInstance.events.addEventListener(C.Events.IndexingWorked,this._onIndexingWorked,this),y.InspectorFrontendHostInstance.events.addEventListener(C.Events.IndexingDone,this._onIndexingDone,this),y.InspectorFrontendHostInstance.events.addEventListener(C.Events.SearchCompleted,this._onSearchCompleted,this),this._initExcludePatterSetting(),this._fileSystemRequestResolve=null,this._fileSystemsLoadedPromise=this._requestFileSystems()}static instance(e={forceNew:null}){const{forceNew:t}=e;return N&&!t||(N=new q),N}_requestFileSystems(){let e;const t=new Promise(t=>{e=t});return y.InspectorFrontendHostInstance.events.addEventListener(C.Events.FileSystemsLoaded,(function(e){const t=e.data,i=[];for(let e=0;e<t.length;++e)i.push(this._innerAddFileSystem(t[e],!1));Promise.all(i).then(s)}),this),y.InspectorFrontendHostInstance.requestFileSystems(),t;function s(t){e(t.filter(e=>!!e))}}addFileSystem(e){return new Promise(t=>{this._fileSystemRequestResolve=t,y.InspectorFrontendHostInstance.addFileSystem(e||"")})}removeFileSystem(e){y.InspectorFrontendHostInstance.removeFileSystem(e.embedderPath())}waitForFileSystems(){return this._fileSystemsLoadedPromise}_innerAddFileSystem(e,t){const s=e.fileSystemPath,n=i.ParsedURL.platformPathToURL(e.fileSystemPath);return L.create(this,n,s,e.type,e.fileSystemName,e.rootURL).then(function(e){if(!e)return null;this._fileSystems.set(n,e),t&&this.dispatchEventToListeners(O.FileSystemAdded,e);return e}.bind(this))}addPlatformFileSystem(e,t){this._fileSystems.set(e,t),this.dispatchEventToListeners(O.FileSystemAdded,t)}_onFileSystemAdded(e){const t=e.data.errorMessage,i=e.data.fileSystem;if(t){if("<selection cancelled>"!==t&&r.Console.instance().error(s.UIString("Unable to add filesystem: %s",t)),!this._fileSystemRequestResolve)return;this._fileSystemRequestResolve.call(null,null),this._fileSystemRequestResolve=null}else i&&this._innerAddFileSystem(i,!0).then(e=>{this._fileSystemRequestResolve&&(this._fileSystemRequestResolve.call(null,e),this._fileSystemRequestResolve=null)})}_onFileSystemRemoved(e){const t=e.data,s=i.ParsedURL.platformPathToURL(t),n=this._fileSystems.get(s);n&&(this._fileSystems.delete(s),n.fileSystemRemoved(),this.dispatchEventToListeners(O.FileSystemRemoved,n))}_onFileSystemFilesChanged(e){const t={changed:s.call(this,e.data.changed),added:s.call(this,e.data.added),removed:s.call(this,e.data.removed)};function s(e){const t=new Platform.Multimap;for(const s of e){const e=i.ParsedURL.platformPathToURL(s);for(const i of this._fileSystems.keys()){if(this._fileSystems.get(i).isFileExcluded(s))continue;const n=i.endsWith("/")?i:i+"/";e.startsWith(n)&&t.set(i,e)}}return t}this.dispatchEventToListeners(O.FileSystemFilesChanged,t)}fileSystems(){return[...this._fileSystems.values()]}fileSystem(e){return this._fileSystems.get(e)||null}_initExcludePatterSetting(){const e=["/Thumbs.db$","/ehthumbs.db$","/Desktop.ini$","/\\$RECYCLE.BIN/"],s=["/\\.DS_Store$","/\\.Trashes$","/\\.Spotlight-V100$","/\\.AppleDouble$","/\\.LSOverride$","/Icon$","/\\._.*$"],i=["/.*~$"];let n=["/node_modules/","/bower_components/","/\\.devtools","/\\.git/","/\\.sass-cache/","/\\.hg/","/\\.idea/","/\\.svn/","/\\.cache/","/\\.project/"];n=g.isWin()?n.concat(e):g.isMac()?n.concat(s):n.concat(i);const o=n.join("|");this._workspaceFolderExcludePatternSetting=t.Settings.instance().createRegExpSetting("workspaceFolderExcludePattern",o,g.isWin()?"i":"")}workspaceFolderExcludePatternSetting(){return this._workspaceFolderExcludePatternSetting}registerCallback(e){const t=++H;return this._callbacks.set(t,e),t}registerProgress(e){const t=++H;return this._progresses.set(t,e),t}_onIndexingTotalWorkCalculated(e){const t=e.data.requestId,s=e.data.totalWork,i=this._progresses.get(t);i&&i.setTotalWork(s)}_onIndexingWorked(e){const t=e.data.requestId,s=e.data.worked,i=this._progresses.get(t);i&&(i.worked(s),i.isCanceled()&&(y.InspectorFrontendHostInstance.stopIndexing(t),this._onIndexingDone(e)))}_onIndexingDone(e){const t=e.data.requestId,s=this._progresses.get(t);s&&(s.done(),this._progresses.delete(t))}_onSearchCompleted(e){const t=e.data.requestId,s=e.data.files,i=this._callbacks.get(t);i&&(i.call(null,s),this._callbacks.delete(t))}}const O={FileSystemAdded:Symbol("FileSystemAdded"),FileSystemRemoved:Symbol("FileSystemRemoved"),FileSystemFilesChanged:Symbol("FileSystemFilesChanged"),ExcludedFolderAdded:Symbol("ExcludedFolderAdded"),ExcludedFolderRemoved:Symbol("ExcludedFolderRemoved")};let H=0;var z=Object.freeze({__proto__:null,IsolatedFileSystemManager:q,Events:O,FileSystem:void 0});class D{constructor(e,t){this._isolatedFileSystemManager=e,this._workspace=t,this._eventListeners=[this._isolatedFileSystemManager.addEventListener(O.FileSystemAdded,this._onFileSystemAdded,this),this._isolatedFileSystemManager.addEventListener(O.FileSystemRemoved,this._onFileSystemRemoved,this),this._isolatedFileSystemManager.addEventListener(O.FileSystemFilesChanged,this._fileSystemFilesChanged,this)],this._boundFileSystems=new Map,this._isolatedFileSystemManager.waitForFileSystems().then(this._onFileSystemsLoaded.bind(this))}static projectId(e){return e}static relativePath(e){const t=e.project()._fileSystemBaseURL;return e.url().substring(t.length).split("/")}static tooltipForUISourceCode(e){return e.project()._fileSystem.tooltipForURL(e.url())}static fileSystemType(e){return e._fileSystem.type()}static fileSystemSupportsAutomapping(e){return e._fileSystem.supportsAutomapping()}static completeURL(e,t){return e._fileSystemBaseURL+t}static fileSystemPath(e){return e}fileSystemManager(){return this._isolatedFileSystemManager}_onFileSystemsLoaded(e){for(const t of e)this._addFileSystem(t)}_onFileSystemAdded(e){const t=e.data;this._addFileSystem(t)}_addFileSystem(e){const t=new $(this,e,this._workspace);this._boundFileSystems.set(e.path(),t)}_onFileSystemRemoved(e){const t=e.data;this._boundFileSystems.get(t.path()).dispose(),this._boundFileSystems.delete(t.path())}_fileSystemFilesChanged(e){const t=e.data;for(const e of t.changed.keysArray()){const s=this._boundFileSystems.get(e);s&&t.changed.get(e).forEach(e=>s._fileChanged(e))}for(const e of t.added.keysArray()){const s=this._boundFileSystems.get(e);s&&t.added.get(e).forEach(e=>s._fileChanged(e))}for(const e of t.removed.keysArray()){const s=this._boundFileSystems.get(e);s&&t.removed.get(e).forEach(e=>s.removeUISourceCode(e))}}dispose(){d.EventTarget.removeEventListeners(this._eventListeners);for(const e of this._boundFileSystems.values())e.dispose(),this._boundFileSystems.delete(e._fileSystem.path())}}class $ extends _.ProjectStore{constructor(e,t,s){const i=t.path(),n=D.projectId(i);console.assert(!s.project(n));const o=i.substr(i.lastIndexOf("/")+1);super(s,n,_.projectTypes.FileSystem,o),this._fileSystem=t,this._fileSystemBaseURL=this._fileSystem.path()+"/",this._fileSystemParentURL=this._fileSystemBaseURL.substr(0,i.lastIndexOf("/")+1),this._fileSystemWorkspaceBinding=e,this._fileSystemPath=i,this._creatingFilesGuard=new Set,s.addProject(this),this.populate()}fileSystemPath(){return this._fileSystemPath}mimeType(e){return this._fileSystem.mimeFromPath(e.url())}initialGitFolders(){return this._fileSystem.initialGitFolders().map(e=>this._fileSystemPath+"/"+e)}_filePathForUISourceCode(e){return e.url().substring(this._fileSystemPath.length)}isServiceProject(){return!1}requestMetadata(e){if(e[G])return e[G];const t=this._filePathForUISourceCode(e),s=this._fileSystem.getMetadata(t).then((function(e){if(!e)return null;return new f.UISourceCodeMetadata(e.modificationTime,e.size)}));return e[G]=s,s}requestFileBlob(e){return this._fileSystem.requestFileBlob(this._filePathForUISourceCode(e))}requestFileContent(e){const t=this._filePathForUISourceCode(e);return this._fileSystem.requestFileContent(t)}canSetFileContent(){return!0}async setFileContent(e,t,s){const i=this._filePathForUISourceCode(e);await this._fileSystem.setFileContent(i,t,s)}fullDisplayName(e){const t=e.project()._fileSystemParentURL;return e.url().substring(t.length)}canRename(){return!0}rename(e,t,s){if(t===e.name())return void s(!0,e.name(),e.url(),e.contentType());let i=this._filePathForUISourceCode(e);this._fileSystem.renameFile(i,t,function(t,n){if(!t||!n)return void s(!1,n);console.assert(n);const o=i.lastIndexOf("/"),r=i.substring(0,o);i=r+"/"+n,i=i.substr(1);const d=this._fileSystemBaseURL+i,a=this._fileSystem.contentType(n);this.renameUISourceCode(e,n),s(!0,n,d,a)}.bind(this))}async searchInFileContent(e,t,s,i){const n=this._filePathForUISourceCode(e),{content:o}=await this._fileSystem.requestFileContent(n);return o?S.performSearchInContent(o,t,s,i):[]}async findFilesMatchingSearchRequest(e,t,s){let i=t;const n=e.queries().slice();n.length||n.push(""),s.setTotalWork(n.length);for(const t of n){const n=await this._fileSystem.searchInPath(e.isRegex()?"":t,s);i=i.intersectOrdered(n.sort(),String.naturalOrderComparator),s.worked(1)}return s.done(),i}indexContent(e){this._fileSystem.indexContent(e)}populate(){const e=this._fileSystem.initialFilePaths();(function t(s){const i=Math.min(s+1e3,e.length);for(let t=s;t<i;++t)this._addFile(e[t]);i<e.length&&setTimeout(t.bind(this,i),100)}).call(this,0)}excludeFolder(e){let t=e.substring(this._fileSystemBaseURL.length);t.startsWith("/")||(t="/"+t),t.endsWith("/")||(t+="/"),this._fileSystem.addExcludedFolder(t);const s=this.uiSourceCodes().slice();for(let t=0;t<s.length;++t){const i=s[t];i.url().startsWith(e)&&this.removeUISourceCode(i.url())}}canExcludeFolder(e){return this._fileSystem.canExcludeFolder(e)}canCreateFile(){return!0}async createFile(e,t,s,i){const n=this._fileSystemPath+e+(e.endsWith("/")?"":"/")+t;this._creatingFilesGuard.add(n);const o=await this._fileSystem.createFile(e,t);if(!o)return null;const r=this._addFile(o);return r.setContent(s,!!i),this._creatingFilesGuard.delete(n),r}deleteFile(e){const t=this._filePathForUISourceCode(e);this._fileSystem.deleteFile(t).then(t=>{t&&this.removeUISourceCode(e.url())})}remove(){this._fileSystemWorkspaceBinding._isolatedFileSystemManager.removeFileSystem(this._fileSystem)}_addFile(e){const t=this._fileSystem.contentType(e),s=this.createUISourceCode(this._fileSystemBaseURL+e,t);return this.addUISourceCode(s),s}_fileChanged(e){if(this._creatingFilesGuard.has(e))return;const t=this.uiSourceCodeForURL(e);if(t)t[G]=null,t.checkContentUpdated();else{const t=this._fileSystem.contentType(e);this.addUISourceCode(this.createUISourceCode(e,t))}}tooltipForURL(e){return this._fileSystem.tooltipForURL(e)}dispose(){this.removeProject()}}const G=Symbol("FileSystemWorkspaceBinding.Metadata");var V=Object.freeze({__proto__:null,FileSystemWorkspaceBinding:D,FileSystem:$,FilesChangedData:void 0});class J{static tooltipForUISourceCode(e){const t=self.Persistence.persistence.binding(e);return t?e===t.network?D.tooltipForUISourceCode(t.fileSystem):t.network.contentType().isFromSourceMap()?s.UIString("Linked to source map: %s",t.network.url().trimMiddle(150)):s.UIString("Linked to %s",t.network.url().trimMiddle(150)):""}static iconForUISourceCode(e){const t=self.Persistence.persistence.binding(e);if(t){if(!t.fileSystem.url().startsWith("file://"))return null;const e=P.Icon.create("mediumicon-file-sync");return e.title=J.tooltipForUISourceCode(t.network),self.Persistence.networkPersistenceManager.project()===t.fileSystem.project()&&(e.style.filter="hue-rotate(160deg)"),e}if(e.project().type()!==_.projectTypes.FileSystem||!e.url().startsWith("file://"))return null;const s=P.Icon.create("mediumicon-file");return s.title=J.tooltipForUISourceCode(e),s}}class Y extends o.ObjectWrapper{constructor(e){super(),e.addEventListener(ne.BindingCreated,this._bindingChanged,this),e.addEventListener(ne.BindingRemoved,this._bindingChanged,this)}_bindingChanged(e){const t=e.data;this.dispatchEventToListeners(w.LinkDecorator.Events.LinkIconChanged,t.network)}linkIcon(e){return J.iconForUISourceCode(e)}}var K=Object.freeze({__proto__:null,PersistenceUtils:J,LinkDecorator:Y});class Q extends o.ObjectWrapper{constructor(e,t){super(),this._workspace=e,this._breakpointManager=t,this._filePathPrefixesToBindingCount=new Map,this._subscribedBindingEventListeners=new Platform.Multimap;const s=new Y(this);w.Linkifier.setLinkDecorator(s),this._mapping=new ae(this._workspace,this._onStatusAdded.bind(this),this._onStatusRemoved.bind(this))}addNetworkInterceptor(e){this._mapping.addNetworkInterceptor(e)}refreshAutomapping(){this._mapping.scheduleRemap()}async addBinding(e){await this._innerAddBinding(e)}async addBindingForTest(e){await this._innerAddBinding(e)}async removeBinding(e){await this._innerRemoveBinding(e)}async removeBindingForTest(e){await this._innerRemoveBinding(e)}async _innerAddBinding(e){e.network[X]=e,e.fileSystem[X]=e,e.fileSystem.forceLoadOnCheckContent(),e.network.addEventListener(f.Events.WorkingCopyCommitted,this._onWorkingCopyCommitted,this),e.fileSystem.addEventListener(f.Events.WorkingCopyCommitted,this._onWorkingCopyCommitted,this),e.network.addEventListener(f.Events.WorkingCopyChanged,this._onWorkingCopyChanged,this),e.fileSystem.addEventListener(f.Events.WorkingCopyChanged,this._onWorkingCopyChanged,this),this._addFilePathBindingPrefixes(e.fileSystem.url()),await this._moveBreakpoints(e.fileSystem,e.network),console.assert(!e.fileSystem.isDirty()||!e.network.isDirty()),e.fileSystem.isDirty()?this._syncWorkingCopy(e.fileSystem):e.network.isDirty()?this._syncWorkingCopy(e.network):e.network.hasCommits()&&e.network.content()!==e.fileSystem.content()&&(e.network.setWorkingCopy(e.network.content()),this._syncWorkingCopy(e.network)),this._notifyBindingEvent(e.network),this._notifyBindingEvent(e.fileSystem),this.dispatchEventToListeners(ne.BindingCreated,e)}async _innerRemoveBinding(e){e.network[X]===e&&(console.assert(e.network[X]===e.fileSystem[X],"ERROR: inconsistent binding for networkURL "+e.network.url()),e.network[X]=null,e.fileSystem[X]=null,e.network.removeEventListener(f.Events.WorkingCopyCommitted,this._onWorkingCopyCommitted,this),e.fileSystem.removeEventListener(f.Events.WorkingCopyCommitted,this._onWorkingCopyCommitted,this),e.network.removeEventListener(f.Events.WorkingCopyChanged,this._onWorkingCopyChanged,this),e.fileSystem.removeEventListener(f.Events.WorkingCopyChanged,this._onWorkingCopyChanged,this),this._removeFilePathBindingPrefixes(e.fileSystem.url()),await this._breakpointManager.copyBreakpoints(e.network.url(),e.fileSystem),this._notifyBindingEvent(e.network),this._notifyBindingEvent(e.fileSystem),this.dispatchEventToListeners(ne.BindingRemoved,e))}async _onStatusAdded(e){const t=new re(e.network,e.fileSystem);e[X]=t,await this._innerAddBinding(t)}async _onStatusRemoved(e){const t=e[X];await this._innerRemoveBinding(t)}_onWorkingCopyChanged(e){const t=e.data;this._syncWorkingCopy(t)}_syncWorkingCopy(t){const s=t[X];if(!s||s[ee])return;const i=s.network===t?s.fileSystem:s.network;if(!t.isDirty())return s[ee]=!0,i.resetWorkingCopy(),s[ee]=!1,void this._contentSyncedForTest();if(e.NetworkProject.targetForUISourceCode(s.network).type()!==m.Type.Node)n.call(this,()=>t.workingCopy());else{const e=t.workingCopy();i.requestContent().then(()=>{const t=Q.rewrapNodeJSContent(i,i.workingCopy(),e);n.call(this,()=>t)})}function n(e){s[ee]=!0,i.setWorkingCopyGetter(e),s[ee]=!1,this._contentSyncedForTest()}}_onWorkingCopyCommitted(e){const t=e.data.uiSourceCode,s=e.data.content;this.syncContent(t,s,e.data.encoded)}syncContent(t,s,i){const n=t[X];if(!n||n[Z])return;const o=n.network===t?n.fileSystem:n.network;function r(e){n[Z]=!0,o.setContent(e,i),n[Z]=!1,this._contentSyncedForTest()}e.NetworkProject.targetForUISourceCode(n.network).type()!==m.Type.Node?r.call(this,s):o.requestContent().then(e=>{const t=Q.rewrapNodeJSContent(o,e.content,s);r.call(this,t)})}static rewrapNodeJSContent(e,t,s){return e.project().type()===_.projectTypes.FileSystem?(s.startsWith(te)&&s.endsWith(se)&&(s=s.substring(te.length,s.length-se.length)),t.startsWith(ie)&&(s=ie+s)):(s.startsWith(ie)&&(s=s.substring(ie.length)),t.startsWith(te)&&t.endsWith(se)&&(s=te+s+se)),s}_contentSyncedForTest(){}async _moveBreakpoints(e,t){const s=this._breakpointManager.breakpointLocationsForUISourceCode(e).map(e=>e.breakpoint);await Promise.all(s.map(e=>(e.remove(!1),this._breakpointManager.setBreakpoint(t,e.lineNumber(),e.columnNumber(),e.condition(),e.enabled()))))}hasUnsavedCommittedChanges(e){return!this._workspace.hasResourceContentTrackingExtensions()&&(!e.project().canSetFileContent()&&(!e[X]&&!!e.hasCommits()))}binding(e){return e[X]||null}subscribeForBindingEvent(e,t){this._subscribedBindingEventListeners.set(e,t)}unsubscribeFromBindingEvent(e,t){this._subscribedBindingEventListeners.delete(e,t)}_notifyBindingEvent(e){if(!this._subscribedBindingEventListeners.has(e))return;const t=Array.from(this._subscribedBindingEventListeners.get(e));for(const e of t)e.call(null)}fileSystem(e){const t=this.binding(e);return t?t.fileSystem:null}network(e){const t=this.binding(e);return t?t.network:null}_addFilePathBindingPrefixes(e){let t="";for(const s of e.split("/")){t+=s+"/";const e=this._filePathPrefixesToBindingCount.get(t)||0;this._filePathPrefixesToBindingCount.set(t,e+1)}}_removeFilePathBindingPrefixes(e){let t="";for(const s of e.split("/")){t+=s+"/";const e=this._filePathPrefixesToBindingCount.get(t);1===e?this._filePathPrefixesToBindingCount.delete(t):this._filePathPrefixesToBindingCount.set(t,e-1)}}filePathHasBindings(e){return e.endsWith("/")||(e+="/"),this._filePathPrefixesToBindingCount.has(e)}}const X=Symbol("Persistence.Binding"),Z=Symbol("Persistence.MuteCommit"),ee=Symbol("Persistence.MuteWorkingCopy"),te="(function (exports, require, module, __filename, __dirname) { ",se="\n});",ie="#!/usr/bin/env node",ne={BindingCreated:Symbol("BindingCreated"),BindingRemoved:Symbol("BindingRemoved")};class oe{constructor(){this._encoder=new a.CharacterIdMap}encode(e){return e.split("/").map(e=>this._encoder.toChar(e)).join("")}decode(e){return e.split("").map(e=>this._encoder.fromChar(e)).join("/")}}class re{constructor(e,t){this.network=e,this.fileSystem=t}}var de=Object.freeze({__proto__:null,PersistenceImpl:Q,NodePrefix:te,NodeSuffix:se,NodeShebang:ie,Events:ne,PathEncoder:oe,PersistenceBinding:re});class ae{constructor(e,t,s){this._workspace=e,this._onStatusAdded=t,this._onStatusRemoved=s,this._statuses=new Set,this._statusSymbol=Symbol("Automapping.Status"),this._processingPromiseSymbol=Symbol("Automapping.ProcessingPromise"),this._metadataSymbol=Symbol("Automapping.Metadata"),this._fileSystemUISourceCodes=new Map,this._sweepThrottler=new l.Throttler(100);const i=new oe;this._filesIndex=new le(i),this._projectFoldersIndex=new ce(i),this._activeFoldersIndex=new ce(i),this._interceptors=[],this._workspace.addEventListener(_.Events.UISourceCodeAdded,e=>this._onUISourceCodeAdded(e.data)),this._workspace.addEventListener(_.Events.UISourceCodeRemoved,e=>this._onUISourceCodeRemoved(e.data)),this._workspace.addEventListener(_.Events.UISourceCodeRenamed,this._onUISourceCodeRenamed,this),this._workspace.addEventListener(_.Events.ProjectAdded,e=>this._onProjectAdded(e.data),this),this._workspace.addEventListener(_.Events.ProjectRemoved,e=>this._onProjectRemoved(e.data),this);for(const t of e.projects())this._onProjectAdded(t);for(const t of e.uiSourceCodes())this._onUISourceCodeAdded(t)}addNetworkInterceptor(e){this._interceptors.push(e),this.scheduleRemap()}scheduleRemap(){for(const e of this._statuses.values())this._clearNetworkStatus(e.network);this._scheduleSweep()}_scheduleSweep(){this._sweepThrottler.schedule(function(){const e=this._workspace.projectsForType(_.projectTypes.Network);for(const t of e)for(const e of t.uiSourceCodes())this._computeNetworkStatus(e);return this._onSweepHappenedForTest(),Promise.resolve()}.bind(this))}_onSweepHappenedForTest(){}_onProjectRemoved(e){for(const t of e.uiSourceCodes())this._onUISourceCodeRemoved(t);if(e.type()!==_.projectTypes.FileSystem)return;const t=e;for(const e of t.initialGitFolders())this._projectFoldersIndex.removeFolder(e);this._projectFoldersIndex.removeFolder(t.fileSystemPath()),this.scheduleRemap()}_onProjectAdded(e){if(e.type()!==_.projectTypes.FileSystem)return;const t=e;for(const e of t.initialGitFolders())this._projectFoldersIndex.addFolder(e);this._projectFoldersIndex.addFolder(t.fileSystemPath()),e.uiSourceCodes().forEach(this._onUISourceCodeAdded.bind(this)),this.scheduleRemap()}_onUISourceCodeAdded(e){const t=e.project();if(t.type()===_.projectTypes.FileSystem){if(!D.fileSystemSupportsAutomapping(t))return;this._filesIndex.addPath(e.url()),this._fileSystemUISourceCodes.set(e.url(),e),this._scheduleSweep()}else t.type()===_.projectTypes.Network&&this._computeNetworkStatus(e)}_onUISourceCodeRemoved(e){if(e.project().type()===_.projectTypes.FileSystem){this._filesIndex.removePath(e.url()),this._fileSystemUISourceCodes.delete(e.url());const t=e[this._statusSymbol];t&&this._clearNetworkStatus(t.network)}else e.project().type()===_.projectTypes.Network&&this._clearNetworkStatus(e)}_onUISourceCodeRenamed(e){const t=e.data.uiSourceCode,s=e.data.oldURL;if(t.project().type()!==_.projectTypes.FileSystem)return;this._filesIndex.removePath(s),this._fileSystemUISourceCodes.delete(s);const i=t[this._statusSymbol];i&&this._clearNetworkStatus(i.network),this._filesIndex.addPath(t.url()),this._fileSystemUISourceCodes.set(t.url(),t),this._scheduleSweep()}_computeNetworkStatus(t){if(t[this._processingPromiseSymbol]||t[this._statusSymbol])return;if(this._interceptors.some(e=>e(t)))return;if(t.url().startsWith("wasm://"))return;const s=this._createBinding(t).then(async function(i){if(!i)return null;if(t[this._processingPromiseSymbol]!==s)return null;if(i.network.contentType().isFromSourceMap()||!i.fileSystem.contentType().isTextType())return i;if(i.fileSystem.isDirty()&&(i.network.isDirty()||i.network.hasCommits()))return null;const[n,o]=await Promise.all([i.fileSystem.requestContent(),i.network.project().requestFileContent(i.network)]);if(null===n.content||null===o)return null;if(t[this._processingPromiseSymbol]!==s)return null;const r=e.NetworkProject.targetForUISourceCode(i.network);let d=!1;const a=n.content;if(r&&r.type()===m.Type.Node){const e=Q.rewrapNodeJSContent(i.fileSystem,a,o.content);d=a===e}else o.content&&(d=a.trimRight()===o.content.trimRight());if(!d)return this._prevalidationFailedForTest(i),null;return i}.bind(this)).then(function(e){if(t[this._processingPromiseSymbol]!==s)return;if(t[this._processingPromiseSymbol]=null,!e)return void this._onBindingFailedForTest();if(e.network[this._statusSymbol]||e.fileSystem[this._statusSymbol])return;if(this._statuses.add(e),e.network[this._statusSymbol]=e,e.fileSystem[this._statusSymbol]=e,e.exactMatch){const t=this._projectFoldersIndex.closestParentFolder(e.fileSystem.url());!!t&&this._activeFoldersIndex.addFolder(t)&&this._scheduleSweep()}this._onStatusAdded.call(null,e)}.bind(this));t[this._processingPromiseSymbol]=s}_prevalidationFailedForTest(e){}_onBindingFailedForTest(){}_clearNetworkStatus(e){if(e[this._processingPromiseSymbol])return void(e[this._processingPromiseSymbol]=null);const t=e[this._statusSymbol];if(t){if(this._statuses.delete(t),t.network[this._statusSymbol]=null,t.fileSystem[this._statusSymbol]=null,t.exactMatch){const e=this._projectFoldersIndex.closestParentFolder(t.fileSystem.url());e&&this._activeFoldersIndex.removeFolder(e)}this._onStatusRemoved.call(null,t)}}_createBinding(e){const t=e.url();if(t.startsWith("file://")||t.startsWith("snippet://")){let s;try{const e=decodeURI(t);s=this._fileSystemUISourceCodes.get(e)}catch(e){r.Console.instance().error(ls`The attempt to bind "${t}" in the workspace failed as this URI is malformed.`)}const i=s?new he(e,s,!1):null;return Promise.resolve(i)}let s=i.ParsedURL.extractPath(t);if(null===s)return Promise.resolve(null);s.endsWith("/")&&(s+="index.html");const n=decodeURI(s),o=this._filesIndex.similarFiles(n).map(e=>this._fileSystemUISourceCodes.get(e));return o.length?this._pullMetadatas(o.concat(e)).then(function(){const t=o.filter(e=>!!this._activeFoldersIndex.closestParentFolder(e.url())),s=e[this._metadataSymbol];if(!s||!s.modificationTime&&"number"!=typeof s.contentSize)return 1!==t.length?null:new he(e,t[0],!1);let i=this._filterWithMetadata(t,s);i.length||(i=this._filterWithMetadata(o,s));if(1!==i.length)return null;return new he(e,i[0],!0)}.bind(this)):Promise.resolve(null)}_pullMetadatas(e){return Promise.all(e.map(async e=>{e[this._metadataSymbol]=await e.requestMetadata()}))}_filterWithMetadata(e,t){return e.filter(e=>{const s=e[this._metadataSymbol];if(!s)return!1;const i=!t.modificationTime||Math.abs(t.modificationTime-s.modificationTime)<1e3,n=!t.contentSize||s.contentSize===t.contentSize;return i&&n})}}class le{constructor(e){this._encoder=e,this._reversedIndex=new c.Trie}addPath(e){const t=this._encoder.encode(e);this._reversedIndex.add(u.reverse(t))}removePath(e){const t=this._encoder.encode(e);this._reversedIndex.remove(u.reverse(t))}similarFiles(e){const t=this._encoder.encode(e),s=u.reverse(t),i=this._reversedIndex.longestPrefix(s,!1);return i?this._reversedIndex.words(i).map(e=>this._encoder.decode(u.reverse(e))):[]}}class ce{constructor(e){this._encoder=e,this._index=new c.Trie,this._folderCount=new Map}addFolder(e){e.endsWith("/")&&(e=e.substring(0,e.length-1));const t=this._encoder.encode(e);this._index.add(t);const s=this._folderCount.get(t)||0;return this._folderCount.set(t,s+1),0===s}removeFolder(e){e.endsWith("/")&&(e=e.substring(0,e.length-1));const t=this._encoder.encode(e),s=this._folderCount.get(t)||0;return!!s&&(s>1?(this._folderCount.set(t,s-1),!1):(this._index.remove(t),this._folderCount.delete(t),!0))}closestParentFolder(e){const t=this._encoder.encode(e),s=this._index.longestPrefix(t,!0);return this._encoder.decode(s)}}class he{constructor(e,t,s){this.network=e,this.fileSystem=t,this.exactMatch=s}}var ue=Object.freeze({__proto__:null,Automapping:ae,AutomappingStatus:he});class me extends b.VBox{constructor(e){super(!0),this.registerRequiredCSS("persistence/editFileSystemView.css"),this._fileSystemPath=e,this._eventListeners=[q.instance().addEventListener(O.ExcludedFolderAdded,this._update,this),q.instance().addEventListener(O.ExcludedFolderRemoved,this._update,this)];const t=this.contentElement.createChild("div","file-system-header");t.createChild("div","file-system-header-text").textContent=s.UIString("Excluded folders"),t.appendChild(I.createTextButton(s.UIString("Add"),this._addExcludedFolderButtonClicked.bind(this),"add-button")),this._excludedFoldersList=new k.ListWidget(this),this._excludedFoldersList.element.classList.add("file-system-list"),this._excludedFoldersList.registerRequiredCSS("persistence/editFileSystemView.css");const i=document.createElement("div");i.classList.add("file-system-list-empty"),i.textContent=s.UIString("None"),this._excludedFoldersList.setEmptyPlaceholder(i),this._excludedFoldersList.show(this.contentElement),this._update()}dispose(){d.EventTarget.removeEventListeners(this._eventListeners)}_update(){if(!this._muteUpdate){this._excludedFoldersList.clear(),this._excludedFolders=[];for(const e of q.instance().fileSystem(this._fileSystemPath).excludedFolders().values())this._excludedFolders.push(e),this._excludedFoldersList.appendItem(e,!0)}}_addExcludedFolderButtonClicked(){this._excludedFoldersList.addNewItem(0,"")}renderItem(e,t){const i=document.createElement("div");i.classList.add("file-system-list-item");const n=t?e:s.UIString("%s (via .devtools)",e),o=i.createChild("div","file-system-value");return o.textContent=n,o.title=n,i}removeItemRequested(e,t){q.instance().fileSystem(this._fileSystemPath).removeExcludedFolder(this._excludedFolders[t])}commitEdit(e,t,s){this._muteUpdate=!0,s||q.instance().fileSystem(this._fileSystemPath).removeExcludedFolder(e),q.instance().fileSystem(this._fileSystemPath).addExcludedFolder(this._normalizePrefix(t.control("pathPrefix").value)),this._muteUpdate=!1,this._update()}beginEdit(e){const t=this._createExcludedFolderEditor();return t.control("pathPrefix").value=e,t}_createExcludedFolderEditor(){if(this._excludedFolderEditor)return this._excludedFolderEditor;const e=new k.Editor;this._excludedFolderEditor=e;const t=e.contentElement();t.createChild("div","file-system-edit-row").createChild("div","file-system-value").textContent=s.UIString("Folder path");return t.createChild("div","file-system-edit-row").createChild("div","file-system-value").appendChild(e.createInput("pathPrefix","text","/path/to/folder/",function(e,t,s){const i=this._normalizePrefix(s.value.trim());if(!i)return{valid:!1,errorMessage:ls`Enter a path`};const n=q.instance().fileSystem(this._fileSystemPath).excludedFolders().size;for(let e=0;e<n;++e)if(e!==t&&this._excludedFolders[e]===i)return{valid:!1,errorMessage:ls`Enter a unique path`};return{valid:!0}}.bind(this))),e}_normalizePrefix(e){return e?e+("/"===e[e.length-1]?"":"/"):""}}var pe=Object.freeze({__proto__:null,EditFileSystemView:me});class _e extends o.ObjectWrapper{constructor(e){super(),this._bindingSymbol=Symbol("NetworkPersistenceBinding"),this._originalResponseContentPromiseSymbol=Symbol("OriginalResponsePromise"),this._savingSymbol=Symbol("SavingForOverrides"),this._enabledSetting=t.Settings.instance().moduleSetting("persistenceNetworkOverridesEnabled"),this._enabledSetting.addChangeListener(this._enabledChanged,this),this._workspace=e,this._networkUISourceCodeForEncodedPath=new Map,this._interceptionHandlerBound=this._interceptionHandler.bind(this),this._updateInterceptionThrottler=new l.Throttler(50),this._project=null,this._activeProject=null,this._active=!1,this._enabled=!1,this._workspace.addEventListener(_.Events.ProjectAdded,e=>{this._onProjectAdded(e.data)}),this._workspace.addEventListener(_.Events.ProjectRemoved,e=>{this._onProjectRemoved(e.data)}),self.Persistence.persistence.addNetworkInterceptor(this._canHandleNetworkUISourceCode.bind(this)),this._eventDescriptors=[],this._enabledChanged()}active(){return this._active}project(){return this._project}originalContentForUISourceCode(e){if(!e[this._bindingSymbol])return null;return e[this._bindingSymbol].fileSystem[this._originalResponseContentPromiseSymbol]||null}async _enabledChanged(){this._enabled!==this._enabledSetting.get()&&(this._enabled=this._enabledSetting.get(),this._enabled?(this._eventDescriptors=[_.WorkspaceImpl.instance().addEventListener(_.Events.UISourceCodeRenamed,e=>{this._uiSourceCodeRenamedListener(e)}),_.WorkspaceImpl.instance().addEventListener(_.Events.UISourceCodeAdded,e=>{this._uiSourceCodeAdded(e)}),_.WorkspaceImpl.instance().addEventListener(_.Events.UISourceCodeRemoved,e=>{this._uiSourceCodeRemovedListener(e)}),_.WorkspaceImpl.instance().addEventListener(_.Events.WorkingCopyCommitted,e=>this._onUISourceCodeWorkingCopyCommitted(e.data.uiSourceCode))],await this._updateActiveProject()):(d.EventTarget.removeEventListeners(this._eventDescriptors),await this._updateActiveProject()))}async _uiSourceCodeRenamedListener(e){const t=e.data.uiSourceCode;await this._onUISourceCodeRemoved(t),await this._onUISourceCodeAdded(t)}async _uiSourceCodeRemovedListener(e){await this._onUISourceCodeRemoved(e.data)}async _uiSourceCodeAdded(e){await this._onUISourceCodeAdded(e.data)}async _updateActiveProject(){const e=this._active;if(this._active=!!(this._enabledSetting.get()&&m.TargetManager.instance().mainTarget()&&this._project),this._active!==e){if(this._active){await Promise.all(this._project.uiSourceCodes().map(e=>this._filesystemUISourceCodeAdded(e)));const e=this._workspace.projectsForType(_.projectTypes.Network);for(const t of e)await Promise.all(t.uiSourceCodes().map(e=>this._networkUISourceCodeAdded(e)))}else this._project&&(await Promise.all(this._project.uiSourceCodes().map(e=>this._filesystemUISourceCodeRemoved(e))),this._networkUISourceCodeForEncodedPath.clear());self.Persistence.persistence.refreshAutomapping()}}_encodedPathFromUrl(e){if(!this._active)return"";let t=i.ParsedURL.urlWithoutHash(e.replace(/^https?:\/\//,""));t.endsWith("/")&&-1===t.indexOf("?")&&(t+="index.html");let s=function(e){const t=[];for(const s of function(e){const t=(e=i.ParsedURL.urlWithoutHash(e)).indexOf("?");if(-1===t)return e.split("/");if(0===t)return[e];const s=e.substr(t),n=e.substr(0,e.length-s.length).split("/");return n[n.length-1]+=s,n}(e)){if(!s)continue;let e=encodeURI(s).replace(/[\/:\?\*]/g,e=>"%"+e[0].charCodeAt(0).toString(16));fe.has(e.toLowerCase())&&(e=e.split("").map(e=>"%"+e.charCodeAt(0).toString(16)).join(""));"."===e.charAt(e.length-1)&&(e=e.substr(0,e.length-1)+"%2e"),t.push(e)}return t}(t);const n=D.fileSystemPath(this._project.id()),o=s.join("/");if(n.length+o.length>200){const e=s[0],n=s[s.length-1],r=n?n.substr(0,10)+"-":"",d=i.ParsedURL.extractExtension(t),a=d?"."+d.substr(0,10):"";s=[e,"longurls",r+String.hashCode(o).toString(16)+a]}return s.join("/")}_decodeLocalPathToUrlPath(e){try{return unescape(e)}catch(e){console.error(e)}return e}async _unbind(e){const t=e[this._bindingSymbol];t&&(delete t.network[this._bindingSymbol],delete t.fileSystem[this._bindingSymbol],await self.Persistence.persistence.removeBinding(t))}async _bind(e,t){e[this._bindingSymbol]&&await this._unbind(e),t[this._bindingSymbol]&&await this._unbind(t);const s=new re(e,t);e[this._bindingSymbol]=s,t[this._bindingSymbol]=s,await self.Persistence.persistence.addBinding(s);const i=e[this._savingSymbol]?e:t,[{content:n},o]=await Promise.all([i.requestContent(),i.contentEncoded()]);self.Persistence.persistence.syncContent(i,n,o)}_onUISourceCodeWorkingCopyCommitted(e){this.saveUISourceCodeForOverrides(e)}canSaveUISourceCodeForOverrides(e){return this._active&&e.project().type()===_.projectTypes.Network&&!e[this._bindingSymbol]&&!e[this._savingSymbol]}async saveUISourceCodeForOverrides(e){if(!this.canSaveUISourceCodeForOverrides(e))return;e[this._savingSymbol]=!0;let t=this._encodedPathFromUrl(e.url());const s=(await e.requestContent()).content||"",i=await e.contentEncoded(),n=t.lastIndexOf("/"),o=t.substr(n+1);t=t.substr(0,n),await this._project.createFile(t,o,s,i),this._fileCreatedForTest(t,o),e[this._savingSymbol]=!1}_fileCreatedForTest(e,t){}_patternForFileSystemUISourceCode(e){const t=D.relativePath(e);return t.length<2?"":"longurls"===t[1]&&2!==t.length?"http?://"+t[0]+"/*":"http?://"+this._decodeLocalPathToUrlPath(t.join("/"))}async _onUISourceCodeAdded(e){await this._networkUISourceCodeAdded(e),await this._filesystemUISourceCodeAdded(e)}_canHandleNetworkUISourceCode(e){return this._active&&!e.url().startsWith("snippet://")}async _networkUISourceCodeAdded(e){if(e.project().type()!==_.projectTypes.Network||!this._canHandleNetworkUISourceCode(e))return;const t=i.ParsedURL.urlWithoutHash(e.url());this._networkUISourceCodeForEncodedPath.set(this._encodedPathFromUrl(t),e);const s=this._project.uiSourceCodeForURL(this._project.fileSystemPath()+"/"+this._encodedPathFromUrl(t));s&&await this._bind(e,s)}async _filesystemUISourceCodeAdded(e){if(!this._active||e.project()!==this._project)return;this._updateInterceptionPatterns();const t=D.relativePath(e),s=this._networkUISourceCodeForEncodedPath.get(t.join("/"));s&&await this._bind(s,e)}_updateInterceptionPatterns(){this._updateInterceptionThrottler.schedule(function(){if(!this._active)return p.MultitargetNetworkManager.instance().setInterceptionHandlerForPatterns([],this._interceptionHandlerBound);const e=new Set;for(const t of this._project.uiSourceCodes()){const s=this._patternForFileSystemUISourceCode(t);e.add(s),s.endsWith("/index.html")&&e.add(s.substr(0,s.length-"index.html".length))}return p.MultitargetNetworkManager.instance().setInterceptionHandlerForPatterns(Array.from(e).map(e=>({urlPattern:e,interceptionStage:Protocol.Network.InterceptionStage.HeadersReceived})),this._interceptionHandlerBound)}.bind(this))}async _onUISourceCodeRemoved(e){await this._networkUISourceCodeRemoved(e),await this._filesystemUISourceCodeRemoved(e)}async _networkUISourceCodeRemoved(e){e.project().type()===_.projectTypes.Network&&(await this._unbind(e),this._networkUISourceCodeForEncodedPath.delete(this._encodedPathFromUrl(e.url())))}async _filesystemUISourceCodeRemoved(e){e.project()===this._project&&(this._updateInterceptionPatterns(),delete e[this._originalResponseContentPromiseSymbol],await this._unbind(e))}async _setProject(e){e!==this._project&&(this._project&&await Promise.all(this._project.uiSourceCodes().map(e=>this._filesystemUISourceCodeRemoved(e))),this._project=e,this._project&&await Promise.all(this._project.uiSourceCodes().map(e=>this._filesystemUISourceCodeAdded(e))),await this._updateActiveProject(),this.dispatchEventToListeners(Se.ProjectChanged,this._project))}async _onProjectAdded(e){if(e.type()!==_.projectTypes.FileSystem||"overrides"!==D.fileSystemType(e))return;D.fileSystemPath(e.id())&&(this._project&&this._project.remove(),await this._setProject(e))}async _onProjectRemoved(e){e===this._project&&await this._setProject(null)}async _interceptionHandler(e){const t=e.request.method;if(!this._active||"GET"!==t&&"POST"!==t)return;const s=this._project.fileSystemPath()+"/"+this._encodedPathFromUrl(e.request.url),i=this._project.uiSourceCodeForURL(s);if(!i)return;let o="";if(e.responseHeaders){o=p.NetworkManager.lowercaseHeaders(e.responseHeaders)["content-type"]}if(!o){const t=n.resourceTypes[e.resourceType]||n.resourceTypes.Other;o=i.mimeType(),n.ResourceType.fromMimeType(o)!==t&&(o=t.canonicalMimeType())}const r=i.project();i[this._originalResponseContentPromiseSymbol]=e.responseBody().then(e=>e.error||null===e.content?null:e.encoded?atob(e.content):e.content);const d=await r.requestFileBlob(i);e.continueRequestWithContent(new Blob([d],{type:o}))}}const fe=new Set(["con","prn","aux","nul","com1","com2","com3","com4","com5","com6","com7","com8","com9","lpt1","lpt2","lpt3","lpt4","lpt5","lpt6","lpt7","lpt8","lpt9"]),Se={ProjectChanged:Symbol("ProjectChanged")};var ye=Object.freeze({__proto__:null,NetworkPersistenceManager:_e,Events:Se});var ge=Object.freeze({__proto__:null,ContextMenuProvider:class{appendApplicableItems(e,t,n){const o=n;o.contentType().isDocumentOrScriptOrStyleSheet()&&t.saveSection().appendItem(s.UIString("Save as..."),(async function(){o instanceof f.UISourceCode&&o.commitWorkingCopy();let e=(await o.requestContent()).content||"";await o.contentEncoded()&&(e=window.atob(e));const t=o.contentURL();self.Workspace.fileManager.save(t,e,!0),self.Workspace.fileManager.close(t)}));const r=_.WorkspaceImpl.instance().uiSourceCodeForURL(o.contentURL());r&&self.Persistence.networkPersistenceManager.canSaveUISourceCodeForOverrides(r)&&t.saveSection().appendItem(s.UIString("Save for overrides"),()=>{r.commitWorkingCopy(),self.Persistence.networkPersistenceManager.saveUISourceCodeForOverrides(r),h.reveal(r)});const d=r&&self.Persistence.persistence.binding(r),a=d?d.fileSystem.contentURL():o.contentURL();if(a.startsWith("file://")){const e=i.ParsedURL.urlToPlatformPath(a,g.isWin());t.revealSection().appendItem(s.UIString("Open in containing folder"),()=>y.InspectorFrontendHostInstance.showItemInFolder(e))}}}});class Fe extends b.VBox{constructor(){super(),this.registerRequiredCSS("persistence/workspaceSettingsTab.css");this.element.createChild("header").createChild("h1").createTextChild(s.UIString("Workspace")),this.containerElement=this.element.createChild("div","settings-container-wrapper").createChild("div","settings-tab settings-content settings-container"),q.instance().addEventListener(O.FileSystemAdded,e=>this._fileSystemAdded(e.data),this),q.instance().addEventListener(O.FileSystemRemoved,e=>this._fileSystemRemoved(e.data),this);const e=this._createFolderExcludePatternInput();e.classList.add("folder-exclude-pattern"),this.containerElement.appendChild(e);this.containerElement.createChild("div","settings-info-message").createTextChild(s.UIString("Mappings are inferred automatically.")),this._fileSystemsListContainer=this.containerElement.createChild("div","");const t=I.createTextButton(ls`Add folder…`,this._addFileSystemClicked.bind(this));this.containerElement.appendChild(t),this.setDefaultFocusedElement(t),this._elementByPath=new Map,this._mappingViewByPath=new Map;const i=q.instance().fileSystems();for(let e=0;e<i.length;++e)this._addItem(i[e])}_createFolderExcludePatternInput(){const e=createElement("p"),t=e.createChild("label");t.textContent=ls`Folder exclude pattern`;const s=I.createInput("","text");x.bindLabelToControl(t,s),e.appendChild(s),s.style.width="270px";const i=q.instance().workspaceFolderExcludePatternSetting(),n=I.bindInput(s,i.set.bind(i),(function(e){let t;try{t=new RegExp(e)}catch(e){}return{valid:!!t}}),!1);return i.addChangeListener(()=>n.call(null,i.get())),n(i.get()),e}_addItem(e){if(!(e instanceof L))return;const t=self.Persistence.networkPersistenceManager.project();if(t&&q.instance().fileSystem(t.fileSystemPath())===e)return;const s=this._renderFileSystem(e);this._elementByPath.set(e.path(),s),this._fileSystemsListContainer.appendChild(s);const i=new me(e.path());this._mappingViewByPath.set(e.path(),i),i.element.classList.add("file-system-mapping-view"),i.show(s)}_renderFileSystem(e){const t=e.path(),i=t.lastIndexOf("/"),n=t.substr(i+1),o=document.createElement("div");o.classList.add("file-system-container");const r=o.createChild("div","file-system-header"),d=r.createChild("div","file-system-name");d.textContent=n,x.markAsHeading(d,2);const a=r.createChild("div","file-system-path");a.textContent=t,a.title=t;const l=new E.Toolbar(""),c=new E.ToolbarButton(s.UIString("Remove"),"largeicon-delete");return c.addEventListener(E.ToolbarButton.Events.Click,this._removeFileSystemClicked.bind(this,e)),l.appendToolbarItem(c),r.appendChild(l.element),o}_removeFileSystemClicked(e){q.instance().removeFileSystem(e)}_addFileSystemClicked(){q.instance().addFileSystem()}_fileSystemAdded(e){this._addItem(e)}_fileSystemRemoved(e){const t=this._mappingViewByPath.get(e.path());t&&(t.dispose(),this._mappingViewByPath.delete(e.path()));const s=this._elementByPath.get(e.path());s&&(this._elementByPath.delete(e.path()),s.remove())}}var ve=Object.freeze({__proto__:null,WorkspaceSettingsTab:Fe});export{ue as Automapping,pe as EditFileSystemView,V as FileSystemWorkspaceBinding,M as IsolatedFileSystem,z as IsolatedFileSystemManager,ye as NetworkPersistenceManager,de as Persistence,ge as PersistenceActions,K as PersistenceUtils,R as PlatformFileSystem,ve as WorkspaceSettingsTab};
