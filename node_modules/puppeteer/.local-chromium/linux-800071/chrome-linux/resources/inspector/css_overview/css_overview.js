import{ObjectWrapper as e,Color as t,ColorUtils as s,Linkifier as i}from"../common/common.js";import{SDKModel as n,CSSModel as o,DOMModel as r}from"../sdk/sdk.js";import{Widget as a,UIUtils as l,Fragment as d,Toolbar as c,Panel as h,SplitWidget as u,TabbedPane as m}from"../ui/ui.js";import{Linkifier as v}from"../components/components.js";import{SortableDataGrid as _,DataGrid as p}from"../data_grid/data_grid.js";import{TextRange as g}from"../text_utils/text_utils.js";import{userMetrics as b,UserMetrics as f}from"../host/host.js";class w extends e.ObjectWrapper{constructor(){super(),this.currentUrl=n.TargetManager.instance().inspectedURL(),n.TargetManager.instance().addEventListener(n.Events.InspectedURLChanged,this._checkUrlAndResetIfChanged,this)}_checkUrlAndResetIfChanged(){this.currentUrl!==n.TargetManager.instance().inspectedURL()&&(this.currentUrl=n.TargetManager.instance().inspectedURL(),this.dispatchEventToListeners(S.Reset))}}const S={RequestOverviewStart:Symbol("RequestOverviewStart"),RequestNodeHighlight:Symbol("RequestNodeHighlight"),PopulateNodes:Symbol("PopulateNodes"),RequestOverviewCancel:Symbol("RequestOverviewCancel"),OverviewCompleted:Symbol("OverviewCompleted"),Reset:Symbol("Reset")};var C=Object.freeze({__proto__:null,OverviewController:w,Events:S});class y{static _add(e,t,s){const i=e.get(t)||[];i.push(s),e.set(t,i)}static checkForUnusedPositionValues(e,t,s,i,n,o,r,a){if("static"===s[i]){if("auto"!==s[n]){const i=ls`Top applied to a statically positioned element`;this._add(e,i,{declaration:"top: "+s[n],nodeId:t})}if("auto"!==s[o]){const i=ls`Left applied to a statically positioned element`;this._add(e,i,{declaration:"left: "+s[o],nodeId:t})}if("auto"!==s[r]){const i=ls`Right applied to a statically positioned element`;this._add(e,i,{declaration:"right: "+s[r],nodeId:t})}if("auto"!==s[a]){const i=ls`Bottom applied to a statically positioned element`;this._add(e,i,{declaration:"bottom: "+s[a],nodeId:t})}}}static checkForUnusedWidthAndHeightValues(e,t,s,i,n,o){if("inline"===s[i]){if("auto"!==s[n]){const i=ls`Width applied to an inline element`;this._add(e,i,{declaration:"width: "+s[n],nodeId:t})}if("auto"!==s[o]){const i=ls`Height applied to an inline element`;this._add(e,i,{declaration:"height: "+s[o],nodeId:t})}}}static checkForInvalidVerticalAlignment(e,t,s,i,n){if(s[i]&&"inline"!==s[i]&&!s[i].startsWith("table")&&"baseline"!==s[n]){const i=ls`Vertical alignment applied to element which is neither inline nor table-cell`;this._add(e,i,{declaration:"vertical-align: "+s[n],nodeId:t})}}}var $=Object.freeze({__proto__:null,CSSOverviewUnusedDeclarations:y});class E extends n.SDKModel{constructor(e){super(e),this._runtimeAgent=e.runtimeAgent(),this._cssAgent=e.cssAgent(),this._domAgent=e.domAgent(),this._domSnapshotAgent=e.domsnapshotAgent(),this._overlayAgent=e.overlayAgent()}highlightNode(e){const s={contentColor:t.PageHighlight.Content.toProtocolRGBA(),showInfo:!0};this._overlayAgent.invoke_hideHighlight({}),this._overlayAgent.invoke_highlightNode({backendNodeId:e,highlightConfig:s})}async getNodeStyleStats(){const e=new Map,s=new Map,i=new Map,n=new Map,o=new Map,r=new Map,a=(e,s,i)=>{if(-1===e)return;const n=m[e];if(!n)return;const o=t.Color.parse(n);if(!o||0===o.rgba()[3])return;const r=o.hasAlpha()?o.asString(t.Format.HEXA):o.asString(t.Format.HEX),a=i.get(r)||new Set;a.add(s),i.set(r,a)},l=e=>new Set(["altglyph","circle","ellipse","path","polygon","polyline","rect","svg","text","textpath","tref","tspan"]).has(e.toLowerCase()),d=e=>new Set(["iframe","video","embed","img"]).has(e.toLowerCase()),c=(e,t)=>new Set(["tr","td","thead","tbody"]).has(e.toLowerCase())&&t.startsWith("table");let h=0;const{documents:u,strings:m}=await this._domSnapshotAgent.invoke_captureSnapshot({computedStyles:["background-color","color","fill","border-top-width","border-top-color","border-bottom-width","border-bottom-color","border-left-width","border-left-color","border-right-width","border-right-color","font-family","font-size","font-weight","line-height","position","top","right","bottom","left","display","width","height","vertical-align"]});for(const{nodes:t,layout:v}of u){h+=v.nodeIndex.length;for(let h=0;h<v.styles.length;h++){const u=v.styles[h],_=v.nodeIndex[h],p=t.backendNodeId[_],g=t.nodeName[_],[b,f,w,S,C,$,E,I,M,k,T,L,x,O,N,R,A,V,F,D,q,B,P,z]=u;if(a(b,p,e),a(f,p,s),l(m[g])&&a(w,p,i),"0px"!==m[S]&&a(C,p,n),"0px"!==m[$]&&a(E,p,n),"0px"!==m[I]&&a(M,p,n),"0px"!==m[k]&&a(T,p,n),L&&-1!==L){const e=m[L],t=o.get(e)||new Map,s="font-size",i="font-weight",n="line-height",r=t.get(s)||new Map,a=t.get(i)||new Map,l=t.get(n)||new Map;if(-1!==x){const e=m[x],t=r.get(e)||[];t.push(p),r.set(e,t)}if(-1!==O){const e=m[O],t=a.get(e)||[];t.push(p),a.set(e,t)}if(-1!==N){const e=m[N],t=l.get(e)||[];t.push(p),l.set(e,t)}t.set(s,r),t.set(i,a),t.set(n,l),o.set(e,t)}y.checkForUnusedPositionValues(r,p,m,R,A,D,V,F),l(m[g])||d(m[g])||y.checkForUnusedWidthAndHeightValues(r,p,m,q,B,P),-1===z||c(m[g],m[q])||y.checkForInvalidVerticalAlignment(r,p,m,q,z)}}return{backgroundColors:e,textColors:s,fillColors:i,borderColors:n,fontInfo:o,unusedDeclarations:r,elementCount:h}}getComputedStyleForNode(e){return this._cssAgent.getComputedStyleForNode(e)}async getMediaQueries(){const e=await this._cssAgent.getMediaQueries(),t=new Map;if(!e)return t;for(const s of e){if("linkedSheet"===s.source)continue;const e=t.get(s.text)||[];e.push(s),t.set(s.text,e)}return t}async getGlobalStylesheetStats(){const{result:e}=await this._runtimeAgent.invoke_evaluate({expression:"(function() {\n      let styleRules = 0;\n      let inlineStyles = 0;\n      let externalSheets = 0;\n      const stats = {\n        // Simple.\n        type: new Set(),\n        class: new Set(),\n        id: new Set(),\n        universal: new Set(),\n        attribute: new Set(),\n\n        // Non-simple.\n        nonSimple: new Set()\n      };\n\n      for (const styleSheet of document.styleSheets) {\n        if (styleSheet.href) {\n          externalSheets++;\n        } else {\n          inlineStyles++;\n        }\n\n        // Attempting to grab rules can trigger a DOMException.\n        // Try it and if it fails skip to the next stylesheet.\n        let rules;\n        try {\n          rules = styleSheet.rules;\n        } catch (err) {\n          continue;\n        }\n\n        for (const rule of rules) {\n          if ('selectorText' in rule) {\n            styleRules++;\n\n            // Each group that was used.\n            for (const selectorGroup of rule.selectorText.split(',')) {\n              // Each selector in the group.\n              for (const selector of selectorGroup.split(/[\\t\\n\\f\\r ]+/g)) {\n                if (selector.startsWith('.')) {\n                  // Class.\n                  stats.class.add(selector);\n                } else if (selector.startsWith('#')) {\n                  // Id.\n                  stats.id.add(selector);\n                } else if (selector.startsWith('*')) {\n                  // Universal.\n                  stats.universal.add(selector);\n                } else if (selector.startsWith('[')) {\n                  // Attribute.\n                  stats.attribute.add(selector);\n                } else {\n                  // Type or non-simple selector.\n                  const specialChars = /[#.:\\[\\]|\\+>~]/;\n                  if (specialChars.test(selector)) {\n                    stats.nonSimple.add(selector);\n                  } else {\n                    stats.type.add(selector);\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n\n      return {\n        styleRules,\n        inlineStyles,\n        externalSheets,\n        stats: {\n          // Simple.\n          type: stats.type.size,\n          class: stats.class.size,\n          id: stats.id.size,\n          universal: stats.universal.size,\n          attribute: stats.attribute.size,\n\n          // Non-simple.\n          nonSimple: stats.nonSimple.size\n        }\n      }\n    })()",returnByValue:!0});if("object"===e.type)return e.value}}n.SDKModel.register(E,n.Capability.DOM,!1);var I=Object.freeze({__proto__:null,CSSOverviewModel:E});class M extends a.Widget{constructor(e){super(),this.registerRequiredCSS("css_overview/cssOverviewStartView.css"),this._controller=e,this._render()}_render(){const e=l.createTextButton(ls`Capture overview`,()=>this._controller.dispatchEventToListeners(S.RequestOverviewStart),"",!0);this.setDefaultFocusedElement(e);const t=d.Fragment.build`
      <div class="vbox overview-start-view">
        <h1>${ls`CSS Overview`}</h1>
        <div>${e}</div>
      </div>
    `;this.contentElement.appendChild(t.element()),this.contentElement.style.overflow="auto"}}var k=Object.freeze({__proto__:null,CSSOverviewStartView:M});class T extends a.Widget{constructor(e){super(),this.registerRequiredCSS("css_overview/cssOverviewProcessingView.css"),this._formatter=new Intl.NumberFormat("en-US"),this._controller=e,this._render()}_render(){const e=l.createTextButton(ls`Cancel`,()=>this._controller.dispatchEventToListeners(S.RequestOverviewCancel),"",!0);this.setDefaultFocusedElement(e),this.fragment=d.Fragment.build`
      <div class="vbox overview-processing-view">
        <h1>Processing page</h1>
        <div>${e}</div>
      </div>
    `,this.contentElement.appendChild(this.fragment.element()),this.contentElement.style.overflow="auto"}}var L=Object.freeze({__proto__:null,CSSOverviewProcessingView:T});class x extends a.VBox{static get ITEM_CLASS_NAME(){return"overview-sidebar-panel-item"}static get SELECTED(){return"selected"}constructor(){super(!0),this.registerRequiredCSS("css_overview/cssOverviewSidebarPanel.css"),this.contentElement.classList.add("overview-sidebar-panel"),this.contentElement.addEventListener("click",this._onItemClick.bind(this));const e=new c.ToolbarButton(ls`Clear overview`,"largeicon-clear");e.addEventListener(c.ToolbarButton.Events.Click,this._reset,this);const t=this.contentElement.createChild("div","overview-toolbar");new c.Toolbar("",t).appendToolbarItem(e)}addItem(e,t){const s=this.contentElement.createChild("div",x.ITEM_CLASS_NAME);s.textContent=e,s.dataset.id=t}_reset(){this.dispatchEventToListeners(O.Reset)}_deselectAllItems(){const e=this.contentElement.querySelectorAll("."+x.ITEM_CLASS_NAME);for(const t of e)t.classList.remove(x.SELECTED)}_onItemClick(e){const t=e.path[0];if(!t.classList.contains(x.ITEM_CLASS_NAME))return;const{id:s}=t.dataset;this.select(s),this.dispatchEventToListeners(O.ItemSelected,s)}select(e){const t=this.contentElement.querySelector(`[data-id=${CSS.escape(e)}]`);t&&(t.classList.contains(x.SELECTED)||(this._deselectAllItems(),t.classList.add(x.SELECTED)))}}const O={ItemSelected:Symbol("ItemSelected"),Reset:Symbol("Reset")};var N=Object.freeze({__proto__:null,CSSOverviewSidebarPanel:x,SidebarEvents:O});class R extends h.PanelWithSidebar{constructor(e,t){super("css_overview_completed_view"),this.registerRequiredCSS("css_overview/cssOverviewCompletedView.css"),this._controller=e,this._formatter=new Intl.NumberFormat("en-US"),this._mainContainer=new u.SplitWidget(!0,!0),this._resultsContainer=new a.VBox,this._elementContainer=new A,this._elementContainer.addEventListener(m.Events.TabClosed,e=>{0===e.data&&this._mainContainer.setSidebarMinimized(!0)}),this._mainContainer.registerRequiredCSS("css_overview/cssOverviewCompletedView.css"),this._mainContainer.setMainWidget(this._resultsContainer),this._mainContainer.setSidebarWidget(this._elementContainer),this._mainContainer.setVertical(!1),this._mainContainer.setSecondIsSidebar(!0),this._mainContainer.setSidebarMinimized(!0),this._sideBar=new x,this.splitWidget().setSidebarWidget(this._sideBar),this.splitWidget().setMainWidget(this._mainContainer),this._cssModel=t.model(o.CSSModel),this._domModel=t.model(r.DOMModel),this._domAgent=t.domAgent(),this._linkifier=new v.Linkifier(20,!0),this._viewMap=new Map,this._sideBar.addItem(ls`Overview summary`,"summary"),this._sideBar.addItem(ls`Colors`,"colors"),this._sideBar.addItem(ls`Font info`,"font-info"),this._sideBar.addItem(ls`Unused declarations`,"unused-declarations"),this._sideBar.addItem(ls`Media queries`,"media-queries"),this._sideBar.select("summary"),this._sideBar.addEventListener(O.ItemSelected,this._sideBarItemSelected,this),this._sideBar.addEventListener(O.Reset,this._sideBarReset,this),this._controller.addEventListener(S.Reset,this._reset,this),this._controller.addEventListener(S.PopulateNodes,this._createElementsView,this),this._resultsContainer.element.addEventListener("click",this._onClick.bind(this)),this._data=null}wasShown(){super.wasShown()}_sideBarItemSelected(e){const t=this._fragment.$(e.data);t&&t.scrollIntoView()}_sideBarReset(){this._controller.dispatchEventToListeners(S.Reset)}_reset(){this._resultsContainer.element.removeChildren(),this._mainContainer.setSidebarMinimized(!0),this._elementContainer.closeTabs(),this._viewMap=new Map}_onClick(e){const t=e.target.dataset.type;if(!t)return;let s;switch(t){case"color":{const i=e.target.dataset.color,n=e.target.dataset.section;if(!i)return;let o;switch(n){case"text":o=this._data.textColors.get(i);break;case"background":o=this._data.backgroundColors.get(i);break;case"fill":o=this._data.fillColors.get(i);break;case"border":o=this._data.borderColors.get(i)}if(!o)return;o=Array.from(o).map(e=>({nodeId:e})),s={type:t,color:i,nodes:o,section:n};break}case"unused-declarations":{const i=e.target.dataset.declaration,n=this._data.unusedDeclarations.get(i);if(!n)return;s={type:t,declaration:i,nodes:n};break}case"media-queries":{const i=e.target.dataset.text,n=this._data.mediaQueries.get(i);if(!n)return;s={type:t,text:i,nodes:n};break}case"font-info":{const i=e.target.dataset.value,[n,o]=e.target.dataset.path.split("/"),r=this._data.fontInfo.get(n).get(o).get(i);if(!r)return;s={type:t,name:`${i} (${n}, ${o})`,nodes:r.map(e=>({nodeId:e}))};break}default:return}e.consume(),this._controller.dispatchEventToListeners(S.PopulateNodes,s),this._mainContainer.setSidebarMinimized(!1)}_onMouseOver(e){const t=e.path.find(e=>e.dataset&&e.dataset.backendNodeId);if(!t)return;const s=Number(t.dataset.backendNodeId);this._controller.dispatchEventToListeners(S.RequestNodeHighlight,s)}async _render(e){if(!e||!("backgroundColors"in e)||!("textColors"in e))return;this._data=e;const{elementCount:t,backgroundColors:s,textColors:i,fillColors:n,borderColors:o,globalStyleStats:r,mediaQueries:a,unusedDeclarations:l,fontInfo:c}=this._data,h=this._sortColorsByLuminance(s),u=this._sortColorsByLuminance(i),m=this._sortColorsByLuminance(n),v=this._sortColorsByLuminance(o);this._fragment=d.Fragment.build`
    <div class="vbox overview-completed-view">
      <div $="summary" class="results-section horizontally-padded summary">
        <h1>${ls`Overview summary`}</h1>

        <ul>
          <li>
            <div class="label">${ls`Elements`}</div>
            <div class="value">${this._formatter.format(t)}</div>
          </li>
          <li>
            <div class="label">${ls`External stylesheets`}</div>
            <div class="value">${this._formatter.format(r.externalSheets)}</div>
          </li>
          <li>
            <div class="label">${ls`Inline style elements`}</div>
            <div class="value">${this._formatter.format(r.inlineStyles)}</div>
          </li>
          <li>
            <div class="label">${ls`Style rules`}</div>
            <div class="value">${this._formatter.format(r.styleRules)}</div>
          </li>
          <li>
            <div class="label">${ls`Media queries`}</div>
            <div class="value">${this._formatter.format(a.size)}</div>
          </li>
          <li>
            <div class="label">${ls`Type selectors`}</div>
            <div class="value">${this._formatter.format(r.stats.type)}</div>
          </li>
          <li>
            <div class="label">${ls`ID selectors`}</div>
            <div class="value">${this._formatter.format(r.stats.id)}</div>
          </li>
          <li>
            <div class="label">${ls`Class selectors`}</div>
            <div class="value">${this._formatter.format(r.stats.class)}</div>
          </li>
          <li>
            <div class="label">${ls`Universal selectors`}</div>
            <div class="value">${this._formatter.format(r.stats.universal)}</div>
          </li>
          <li>
            <div class="label">${ls`Attribute selectors`}</div>
            <div class="value">${this._formatter.format(r.stats.attribute)}</div>
          </li>
          <li>
            <div class="label">${ls`Non-simple selectors`}</div>
            <div class="value">${this._formatter.format(r.stats.nonSimple)}</div>
          </li>
        </ul>
      </div>

      <div $="colors" class="results-section horizontally-padded colors">
        <h1>${ls`Colors`}</h1>
        <h2>${ls`Background colors: ${h.length}`}</h2>
        <ul>
          ${h.map(this._colorsToFragment.bind(this,"background"))}
        </ul>

        <h2>${ls`Text colors: ${u.length}`}</h2>
        <ul>
          ${u.map(this._colorsToFragment.bind(this,"text"))}
        </ul>

        <h2>${ls`Fill colors: ${m.length}`}</h2>
        <ul>
          ${m.map(this._colorsToFragment.bind(this,"fill"))}
        </ul>

        <h2>${ls`Border colors: ${v.length}`}</h2>
        <ul>
          ${v.map(this._colorsToFragment.bind(this,"border"))}
        </ul>
      </div>

      <div $="font-info" class="results-section font-info">
        <h1>${ls`Font info`}</h1>
        ${c.size>0?this._fontInfoToFragment(c):d.Fragment.build`<div>${ls`There are no fonts.`}</div>`}
      </div>

      <div $="unused-declarations" class="results-section unused-declarations">
        <h1>${ls`Unused declarations`}</h1>
        ${l.size>0?this._groupToFragment(l,"unused-declarations","declaration"):d.Fragment.build`<div class="horizontally-padded">${ls`There are no unused declarations.`}</div>`}
      </div>

      <div $="media-queries" class="results-section media-queries">
        <h1>${ls`Media queries`}</h1>
        ${a.size>0?this._groupToFragment(a,"media-queries","text"):d.Fragment.build`<div class="horizontally-padded">${ls`There are no media queries.`}</div>`}
      </div>
    </div>`,this._resultsContainer.element.appendChild(this._fragment.element())}_createElementsView(e){const{type:t,nodes:s}=e.data;let i="",n="";switch(t){case"color":{const{section:t,color:s}=e.data;i=`${t}-${s}`,n=`${s.toUpperCase()} (${t})`;break}case"unused-declarations":{const{declaration:t}=e.data;i=""+t,n=""+t;break}case"media-queries":{const{text:t}=e.data;i=""+t,n=""+t;break}case"font-info":{const{name:t}=e.data;i=""+t,n=""+t;break}}let o=this._viewMap.get(i);o||(o=new V(this._controller,this._domModel,this._cssModel,this._linkifier),o.populateNodes(s),this._viewMap.set(i,o)),this._elementContainer.appendTab(i,n,o,!0)}_fontInfoToFragment(e){const t=Array.from(e.entries());return d.Fragment.build`
      ${t.map(([e,t])=>d.Fragment.build`<section class="font-family"><h2>${e}</h2> ${this._fontMetricsToFragment(e,t)}</section>`)}
    `}_fontMetricsToFragment(e,t){const s=Array.from(t.entries());return d.Fragment.build`
      <div class="font-metric">
      ${s.map(([t,s])=>{const i=`${e}/${t}`;return d.Fragment.build`
          <div>
            <h3>${t}</h3>
            ${this._groupToFragment(s,"font-info","value",i)}
          </div>`})}
      </div>`}_groupToFragment(e,t,s,i=""){const n=Array.from(e.entries()).sort((e,t)=>{const s=e[1];return t[1].length-s.length}),o=n.reduce((e,t)=>e+t[1].length,0);return d.Fragment.build`<ul>
    ${n.map(([e,n])=>{const r=100*n.length/o,a=1===n.length?ls`occurrence`:ls`occurrences`;return d.Fragment.build`<li>
        <div class="title">${e}</div>
        <button data-type="${t}" data-path="${i}" data-${s}="${e}">
          <div class="details">${ls`${n.length} ${a}`}</div>
          <div class="bar-container">
            <div class="bar" style="width: ${r}%"></div>
          </div>
        </button>
      </li>`})}
    </ul>`}_colorsToFragment(e,s){const i=d.Fragment.build`<li>
      <button data-type="color" data-color="${s}" data-section="${e}" class="block" $="color"></button>
      <div class="block-title">${s}</div>
    </li>`,n=i.$("color");n.style.backgroundColor=s;const o=t.Color.parse(s);let[r,a,l]=o.hsla();r=Math.round(360*r),a=Math.round(100*a),l=Math.round(100*l),l=Math.max(0,l-15);const c=`1px solid hsl(${r}, ${a}%, ${l}%)`;return n.style.border=c,i}_sortColorsByLuminance(e){return Array.from(e.keys()).sort((e,i)=>{const n=t.Color.parse(e),o=t.Color.parse(i);return s.luminance(o.rgba())-s.luminance(n.rgba())})}setOverviewData(e){this._render(e)}}R.pushedNodes=new Set;class A extends a.VBox{constructor(){super(),this._tabbedPane=new m.TabbedPane,this._tabbedPane.show(this.element),this._tabbedPane.addEventListener(m.Events.TabClosed,()=>{this.dispatchEventToListeners(m.Events.TabClosed,this._tabbedPane.tabIds().length)})}appendTab(e,t,s,i){this._tabbedPane.hasTab(e)||this._tabbedPane.appendTab(e,t,s,void 0,void 0,i),this._tabbedPane.selectTab(e)}closeTabs(){this._tabbedPane.closeTabs(this._tabbedPane.tabIds())}}class V extends a.Widget{constructor(e,t,s,i){super(),this._controller=e,this._domModel=t,this._cssModel=s,this._linkifier=i,this._elementGridColumns=[{id:"nodeId",title:ls`Element`,visible:!1,sortable:!0,hideable:!0,weight:50},{id:"declaration",title:ls`Declaration`,visible:!1,sortable:!0,hideable:!0,weight:50},{id:"sourceURL",title:ls`Source`,visible:!0,sortable:!1,hideable:!0,weight:100}],this._elementGrid=new _.SortableDataGrid({displayName:ls`CSS Overview Elements`,columns:this._elementGridColumns}),this._elementGrid.element.classList.add("element-grid"),this._elementGrid.element.addEventListener("mouseover",this._onMouseOver.bind(this)),this._elementGrid.setStriped(!0),this._elementGrid.addEventListener(p.Events.SortingChanged,this._sortMediaQueryDataGrid.bind(this)),this.element.appendChild(this._elementGrid.element)}_sortMediaQueryDataGrid(){const e=this._elementGrid.sortColumnId();if(!e)return;const t=_.SortableDataGrid.StringComparator.bind(null,e);this._elementGrid.sortNodes(t,!this._elementGrid.isSortOrderAscending())}_onMouseOver(e){const t=e.path.find(e=>e.dataset&&e.dataset.backendNodeId);if(!t)return;const s=Number(t.dataset.backendNodeId);this._controller.dispatchEventToListeners(S.RequestNodeHighlight,s)}async populateNodes(e){if(this._elementGrid.rootNode().removeChildren(),!e.length)return;const[t]=e,s={nodeId:!!t.nodeId,declaration:!!t.declaration,sourceURL:!!t.sourceURL};let i;if(s.nodeId){const t=e.reduce((e,t)=>R.pushedNodes.has(t.nodeId)?e:(R.pushedNodes.add(t.nodeId),e.add(t.nodeId)),new Set);i=await this._domModel.pushNodesByBackendIdsToFrontend(t)}for(const t of e){if(s.nodeId){const e=i.get(t.nodeId);if(!e)continue;t.node=e}const e=new F(this._elementGrid,t,this._linkifier,this._cssModel);e.selectable=!1,this._elementGrid.insertChild(e)}this._elementGrid.setColumnsVisiblity(s),this._elementGrid.renderInline(),this._elementGrid.wasShown()}}class F extends _.SortableDataGridNode{constructor(e,t,s,i){super(e,t.hasChildren),this.data=t,this._linkifier=s,this._cssModel=i}createCell(e){if("nodeId"===e){const t=this.createTD(e);return t.textContent="...",i.Linkifier.linkify(this.data.node).then(e=>{t.textContent="",e.dataset.backendNodeId=this.data.node.backendNodeId(),t.appendChild(e)}),t}if("sourceURL"===e){const t=this.createTD(e);if(this.data.range){const e=this._linkifyRuleLocation(this._cssModel,this._linkifier,this.data.styleSheetId,g.TextRange.fromObject(this.data.range));""!==e.textContent?t.appendChild(e):t.textContent="(unable to link)"}else t.textContent="(unable to link to inlined styles)";return t}return super.createCell(e)}_linkifyRuleLocation(e,t,s,i){const n=e.styleSheetHeaderForId(s),r=n.lineNumberInSource(i.startLine),a=n.columnNumberInSource(i.startLine,i.startColumn),l=new o.CSSLocation(n,r,a);return t.linkifyCSSLocation(l)}}var D=Object.freeze({__proto__:null,CSSOverviewCompletedView:R,DetailsView:A,ElementDetailsView:V,ElementNode:F});class q extends h.Panel{constructor(){super("css_overview"),this.registerRequiredCSS("css_overview/cssOverview.css"),this.element.classList.add("css-overview-panel");const[e]=n.TargetManager.instance().models(E);this._model=e,this._controller=new w,this._startView=new M(this._controller),this._processingView=new T(this._controller),this._completedView=new R(this._controller,e.target()),this._controller.addEventListener(S.RequestOverviewStart,e=>{b.actionTaken(f.Action.CaptureCssOverviewClicked),this._startOverview()},this),this._controller.addEventListener(S.RequestOverviewCancel,this._cancelOverview,this),this._controller.addEventListener(S.OverviewCompleted,this._overviewCompleted,this),this._controller.addEventListener(S.Reset,this._reset,this),this._controller.addEventListener(S.RequestNodeHighlight,this._requestNodeHighlight,this),this._reset()}_reset(){this._backgroundColors=new Map,this._textColors=new Map,this._fillColors=new Map,this._borderColors=new Map,this._fontInfo=new Map,this._mediaQueries=[],this._unusedDeclarations=new Map,this._elementCount=0,this._cancelled=!1,this._globalStyleStats={styleRules:0,inlineStyles:0,externalSheets:0,stats:{type:0,class:0,id:0,universal:0,attribute:0,nonSimple:0}},this._renderInitialView()}_requestNodeHighlight(e){this._model.highlightNode(e.data)}_renderInitialView(){this._processingView.hideWidget(),this._completedView.hideWidget(),this._startView.show(this.contentElement)}_renderOverviewStartedView(){this._startView.hideWidget(),this._completedView.hideWidget(),this._processingView.show(this.contentElement)}_renderOverviewCompletedView(){this._startView.hideWidget(),this._processingView.hideWidget(),this._completedView.show(this.contentElement),this._completedView.setOverviewData({backgroundColors:this._backgroundColors,textColors:this._textColors,fillColors:this._fillColors,borderColors:this._borderColors,globalStyleStats:this._globalStyleStats,fontInfo:this._fontInfo,elementCount:this._elementCount,mediaQueries:this._mediaQueries,unusedDeclarations:this._unusedDeclarations})}async _startOverview(){this._renderOverviewStartedView();const[e,{elementCount:t,backgroundColors:s,textColors:i,fillColors:n,borderColors:o,fontInfo:r,unusedDeclarations:a},l]=await Promise.all([this._model.getGlobalStylesheetStats(),this._model.getNodeStyleStats(),this._model.getMediaQueries()]);t&&(this._elementCount=t),e&&(this._globalStyleStats=e),l&&(this._mediaQueries=l),s&&(this._backgroundColors=s),i&&(this._textColors=i),n&&(this._fillColors=n),o&&(this._borderColors=o),r&&(this._fontInfo=r),a&&(this._unusedDeclarations=a),this._controller.dispatchEventToListeners(S.OverviewCompleted)}_getStyleValue(e,t){const s=e.filter(e=>e.name===t);if(s.length)return s[0].value}_cancelOverview(){this._cancelled=!0}_overviewCompleted(){this._renderOverviewCompletedView()}}var B=Object.freeze({__proto__:null,CSSOverviewPanel:q});export{D as CSSOverviewCompletedView,C as CSSOverviewController,I as CSSOverviewModel,B as CSSOverviewPanel,L as CSSOverviewProcessingView,N as CSSOverviewSidebarPanel,k as CSSOverviewStartView,$ as CSSOverviewUnusedDeclarations};
